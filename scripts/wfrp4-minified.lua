a=true b=1 c=97 d=true e=true f=0.5 function g(H,I)if(H == I and true)then return true else return false end end function h(H,I)if H == 0 and I == 0 then return 100 else return H * 10+I end end function i(H,I)if(H <= I or (a and H <= b))and not (a and H >= c)then return true else return false end end function j(H,I)if H >= I or H >= c then return true else return false end end function k(H,I,J)if(d and g(I, J))or((H ~= "corps-a-corps" or H ~= "distance") and a and (h(I, J) <= b or h(I, J) >= c))then return true else return false end end function l(H)H= tostring(H)or"I"if H=="TF"then return 60 elseif H=="F"then return 40 elseif H=="A"then return 20 elseif H=="I"then return 0 elseif H=="C"then return-10 elseif H=="D"then return-20 elseif H=="TD"then return-30 end end function m(H)H=string.lower(H)if H == "tf"or H == "tresfacile"then return"TF"elseif H == "f"or H == "facile"then return"F"elseif H == "a"or H == "accessible"then return"A"elseif H == "i" or H == "intermediaire"or H == "intermédiaire"then return"I"elseif H == "c"or H == "complexe"then return"C"elseif H == "d"or H == "difficile"then return"D"elseif H == "td"or H == "tresdifficile"then return"TD"end end function n(H)H=string.lower(H)if H == "tf"or H == "tresfacile"then return"Très Facile"elseif H == "f"or H == "facile"then return"Facile"elseif H == "a"or H == "accessible"then return"Accessible"elseif H == "i" or H == "intermediaire"or H == "intermédiaire"then return"Intermédiaire"elseif H == "c"or H == "complexe"then return"Complexe"elseif H == "d"or H == "difficile"then return"Difficile"elseif H == "td"or H == "tresdifficile"then return"Très Difficile"end end function o(H)H=string.lower(H)if H == "tf"or H == "tresfacile"then return"+60"elseif H == "f"or H == "facile"then return"+40"elseif H == "a"or H == "accessible"then return"+20"elseif H == "i" or H == "intermediaire"or H == "intermédiaire"then return"0"elseif H == "c"or H == "complexe"then return"-10"elseif H == "d"or H == "difficile"then return"-20"elseif H == "td"or H == "tresdifficile"then return"-30"end end function p(H)H=tonumber(H)if H<=0 then return"+0"elseif H>0 then return"+"..H * 10 end end function q(H,I)local J= H+I if(J < 1 and true)then J=1 end return J end function r(H,I)local J= (I - H)/10 local K=0 if(J > 0 and true)then K=math.floor(J)elseif(J < 0 and true)then K=math.ceil(J)end K= K+s(I)return K end function s(H)local I=0 if e then if(H > 100 and true)then I=math.floor((H - 100)/10)end else I=0 end return I end function t(H,I,J,K,L,M)local N=0 local O= H-J print("bilanDR:",O)print("BFattaquant:",I)print("BEattaque:",K)local P,Q=string.match(L,".*(%+BF)%s*(%+%d*)")P= P~=nil Q=tonumber(Q)print("appliqueBF",P)print("degatsEffectifsArme",Q)if P then print("appliqueBF true")Q= Q+I else print("appliqueBF false")Q=Q end N= Q+O print("degatsEffectifs:",N)local R=string.format("%dDR %s",O,L)print("libelleCalculDegats:",R)local S=""print("atoutsDefautsArme['inoffensive']",M['inoffensive'])if(f < 1 and not M['inoffensive']and true)then N= N-math.ceil(K * f)S=string.format(' - (%dBE * %.1f)',K,f)print("degatsEffectifs",N)print("libelleBE",S)else N= N-K S=string.format(' - %dBE',K)print("degatsEffectifs",N)print("libelleBE",S)end R= R..S print('libelleCalculDegats',R)if(N < 0 and true)then N=0 end print(R.." = " .. N)return N,R end function u(H)if(H >= 1 and H <= 9)then return"Tête"elseif(H >= 10 and H <= 24)then return"Bras secondaire"elseif(H >= 25 and H <= 44)then return"Bras principal"elseif(H >= 45 and H <= 79)then return"Corps"elseif(H >= 80 and H <= 89)then return"Jambe gauche"elseif(H >= 90 and H <= 100)then return"Jambe droite"end end function v(H)local I=""if H=="tête"then I="à la Tête"elseif H=="bras secondaire"then I="au niveau du Bras gauche (ou du bras secondaire)"elseif H=="bras principal"then I="au niveau du Bras droit (ou du bras principal)"elseif H=="corps"then I="au niveau du Corps"elseif H=="jambe gauche"then I="au niveau de la Jambe gauche"elseif H=="jambe droite"then I="au niveau de la Jambe droite"end return I end function w(H,I)if(H >= 1 and H <= 20 and true)then return string.format("%s se blesse tout seul en attaquant, et perd un Point de Blessure sans tenir compte du Bonus d'Endurance ou des Points d'Armure.",I)elseif H >= 21 and H <= 40 then return string.format("L'arme de Corps-à-Corps de %s s'ébrèche salement, ou l'arme de tir à distance ne fonctionne pas ou se trouve sur le point de se briser. L'arme subit 1 point de Dégâts. Au prochain Round, %s agira en dernier sans tenir compte de l'ordre d'initiative, des talents ni de toute règle spéciale pendant que le porteur gère la situation.",I)elseif H >= 41 and H <= 60 then return string.format("%s a mal négocié sa manoeuvre, ce qui le met en mauvaise posture. Au cours du prochain round, votre action subira une pénalité de -10.",I)elseif H >= 61 and H <= 70 then return string.format("%s trébuche franchement et peine à se redresser, il perd son prochain Mouvement.",I)elseif H >= 71 and H <= 80 then return string.format("%s ne tient pas son arme correctement ou laisse tomber ses munitions, il perd sa prochaine Action.",I)elseif H >= 81 and H <= 90 then return string.format("%s effectue un mouvement trop ample, ou trébuche et se tord la cheville, subissant un traumatisme [i]Déchirure musculaire (Mineure)[/i] comptant comme une Blessure critique.",I)elseif H >= 91 and H <= 100 then return string.format("%s manque complètement son attaque et touche un allié au hasard à distance en utilisant le chiffre des unités du lancer de dés pour déterminer le DR. Si personne n'est à distance, il se blesse tout seul et obtient l'État [i]Sonné[/i].",I)end end function x(H,I,J)print("GetLibelleEffetCoupCritiques:",H,I,J)local K=rpg.roll.dice(2,0,9)local L=K[1]local M=K[2]local N="testVar :)"local O=h(L,M)local P=""local Q=0 local R=""if H=="Tête"then if O >= 1 and O <= 10 then P="Blessure spectaculaire"Q=1 R=string.format("l'attaque de %s produit une fine entaille qui va du front de %s jusqu'à la joue. +1 État [i]Hémorragique[/i]. Une fois que la blessure est guérie, l'impressionnante cicatrice permet d'obtenir DR+1 à certains tests sociaux.",I,J)elseif O >= 11 and O <= 20 then P="Coupure mineure"Q=1 R=string.format("le coup de %s entaille la joue de %s et le sang dégouline partout. +1 État [i]Hémorragique[/i].",I,J)elseif O >= 21 and O <= 25 then P="Coup à l'oeil"Q=1 R=string.format("le coup de %s touche %s à l'orbite de l'oeil. +1 État [i]Aveuglé[/i].",I,J)elseif O >= 26 and O <= 30 then P="Frappe à l'oreille"Q=1 R=string.format("le coup de %s touche à l'orbite de l'oreille et %s perçoit un bourdonnement ignoble. +1 État [i]Assourdi[/i].",I,J)elseif O >= 31 and O <= 35 then P="Coup percutant"Q=2 R=string.format("le sang obsurcit la vision de %s, qui perçoit des points blancs et des flashs de lumière. +1 État [i]Sonné[/i].",J)elseif O >= 36 and O <= 40 then P="Oeil au beurre noir"Q=2 R=string.format("%s assène un coup massif et très douloureux au niveau des yeux de %s. +2 États [i]Aveuglé[/i].",I,J)elseif O >= 41 and O <= 45 then P="Oreille tranchée"Q=2 R=string.format("%s assène un coup très violent sur le côté de la tête de %s, entaillant profondément l'oreille. +2 États [i]Assourdi[/i] et +1 État [i]Hémorragique[/i].",I,J)elseif O >= 46 and O <= 50 then P="En plein front"Q=2 R=string.format("%s assène est un coup percutant en plein front de %s. +2 États [i]Hémorragique[/i] et +1 État [i]Aveuglé[/i] qui ne peut être retiré tant que tous les États [i]Hémorragique[/i] n'ont pas été éliminés.",I,J)elseif O >= 51 and O <= 55 then P="Mâchoire fracturée"Q=3 R=string.format("le coup de %s fracture la mâchoire de %s avec un bruit dégoûtant. Les vagues de douleur déferlent instantanément. +2 États [i]Sonné[/i] et subissez le Traumatisme [i]Fracture (Mineure)[/i].",I,J)elseif O >= 56 and O <= 60 then P="Blessure majeure à l'oeil"Q=3 R=string.format("le coup de %s lézarde l'orbite d'un oeil de %s. +1 État [i]Hémorragique[/i]. +1 État [i]Aveuglé[/i] qui ne pourra être soigné que lorsqu'on vous appliquera Aide Médicale.",I,J)elseif O >= 61 and O <= 65 then P="Blessure majeure à l'oreille"Q=3 R=string.format("le coup de %s endommage l'oreille de %s, lui causant une perte auditive permanente. %s subit désormais une pénalité de -20 à tout Test ayant un rapport avec l'audition. Si %s tombe une seconde fois sur cette blessure, il perd totalement l'audition car votre deuxième oreille devient elle aussi silencieuse. Ne peut être guéri que par la magie.",I,J,J,J)elseif O >= 66 and O <= 70 then P="Nez cassé"Q=3 R=string.format("%s porte un coup violent au nez de %s, qui déverse instantanément des flots de sang. +2 États [i]Hémorragique[/i]. Réussissez un Test de [b]Résistance Intermédiaire (+0)[/b] ou gagnez l'État [i]Sonné[/i]. Une fois cette blessure guérie, gagnez [b]DR+1/-1[/b] aux Tests Sociaux en fonction du contexte, jusqu'à ce que [b]Chirurgie[/b] soit utilisée sur le nez pour le réparer.",I,J)elseif O >= 71 and O <= 75 then P="Mâchoire cassée"Q=4 R=string.format("le coup de %s brise la mâchoire de %s avec un bruit ignoble. +3 États [i]Sonné[/i]. Réussissez un Test de [b]Résistance Intermédiaire (+0)[/b] ou gagnez l'État [i]Inconscient[/i]. +1 Traumatisme [b]Fracture (Majeure)[/b]",I,J)elseif O >= 76 and O <= 80 then P="Commotion cérébrale"Q=4 R=string.format("le cerveau de %s bouge à l'intérieur de la boîte crânienne, alors que le sang coule à flots du nez et des oreilles. +1 État [i]Assourdi[/i], +2 États [i]Hémorragique[/i] et +1D10 États [i]Sonné[/i]. +1 État [i]Exténué[/i] pour 1D10 jours. Si vous recevez une autre Blessure critique à la tête alors que vous êtes [i]Exténué[/i], réussissez un Test de [b]Résistance Accessible (+20)[/b] ou +1 État [i]Inconscient[/i].",J)elseif O >= 81 and O <= 85 then P="Bouche explosée"Q=4 R=string.format("la bouche de %s se remplit de sang et de dents cassées avec un bruit répugnant. +2 États [i]Hémorragique[/i]. Perdez 1D10 dents — [b]Amputation (Facile)[/b].",J)elseif O >= 86 and O <= 90 then P="Oreille mutilée"Q=4 R=string.format("Il ne reste plus grand-chose de l'oreille de %s après que le coup de %s l'ait déchiquetée. +3 États [i]Assourdi[/i] et +2 États [i]Hémorragique[/i]. L'oreille est perdue — [b]Amputation (Accessible)[/b]",J,I)elseif O >= 91 and O <= 93 then P="Œil crevé"Q=5 R=string.format("le coup de %s crève l'oeil de %s, provoquant une douleur quasi-insoutenable. +3 États [i]Aveuglé[/i], +2 États [i]Hémorragique[/i] et +1 États [i]Sonné[/i]. L'œil est perdu — [b]Amputation (Complexe)[/b]",I,J)elseif O >= 94 and O <= 96 then P="Coup défigurant"Q=5 R=string.format("le coup de %s explose le visage de %s, crevant un œil et brisant le nez. +3 États [i]Hémorragique[/i], +3 États [i]Aveuglé[/i] et +2 États [i]Sonné[/i]. L'œil et le nez sont perdus — [b]Amputation (Difficile)[/b]",I,J)elseif O >= 97 and O <= 99 then P="Mâchoire mutilée"Q=5 R=string.format("le coup de %s arrache presque complètement la mâchoire de %s, détruit la langue et envoie les dents à plusieurs mètres dans une pluie de sang. +4 États [i]Hémorragique[/i], +3 États [i]Sonné[/i]. Réussissez un Test de Résistance Très Difficile (-30) ou +1 État [i]Inconscient[/i]. +1 Traumatisme [b]Fracture (Majeure)[/b], la langue est perdue et 1D10 dents — [b]Amputation (Difficile)[/b]",I,J)elseif O==100 then P="Mort"Q=666 R=string.format("%s tranche la tête de %s au niveau du cou, elle part dans les airs, atterrissant à 1D3 mètres du corps dans une direction aléatoire (voir [b]Dispersion[/b]). La mort est instantanée, et le corps s'effondre sans vie.",I,J)end elseif H == "Bras secondaire"or H == "Bras principal"then if O >= 1 and O <= 10 then P="Choc au bras"Q=1 R=string.format("le %s de %s prend un choc au cours de l'attaque. %s lâche ce qu'il tenait.",H,J)elseif O >= 11 and O <= 20 then P="Coupure mineure"Q=1 R=string.format("%s saigne abondamment au niveau de l'avant-bras. +1 État [i]Hémorragique[/i].",J)elseif O >= 21 and O <= 25 then P="Torsion"Q=1 R=string.format("%s se tord le bras, occasionnant +1 Traumatisme [i]Déchirure musculaire (Mineure)[/i]",J)elseif O >= 26 and O <= 30 then P="Choc violent au bras"Q=2 R=string.format("%s reçoit un coup particulièrement violent %s et lâche ce qu'il avait dans la main, cette dernière restant inutilisable pendant 1D10 - Bonus d'Endurance Rounds (minimum 1). Pendant ce temps, considérez votre main comme perdue (voir Membres Amputés, p180).",J,H)elseif O >= 31 and O <= 35 then P="Déchirure musculaire"Q=2 R=string.format("le coup écrase l'avant-bras (%s) de %s. +1 État [i]Hémorragique[/i] et +1 Traumatisme [i]Déchirure musculaire (Mineure)[/i].",H,J)elseif O >= 36 and O <= 40 then P="Main ensanglantée"Q=2 R=string.format("la main (%s) de %s est bien entaillée. Le sang rend la prise glissante avec cette main. +1 État [i]Hémorragique[/i]. Test de [i]Dextérité (Accessible)[/i] pour effectuer toute action avec un objet dans la main, sinon il échappe des mains.",H,J)elseif O >= 41 and O <= 45 then P="Clef de bras"Q=2 R=string.format("l'articulation du %s de %s est pratiquement arrachée. La main correspondante lâche ce qu'elle tenait, le bras est inutilisable pendant 1D10 Rounds.",H,J)elseif O >= 46 and O <= 50 then P="Blessure béante"Q=3 R=string.format("le coup ouvre une blessure béante. +2 États [i]Hémorragique[/i]. Jusqu'à ce que %s soit soigné par Chirurgie afin de recoudre la blessure, tout nouveau Dégât au %s redonnera +1 État [i]Hémorragique[/i], la blessure s'étant réouverte.",J,H)elseif O >= 51 and O <= 55 then P="Cassure nette"Q=3 R=string.format("un craquement significatif se fait entendre au moment où le coup s'abat sur le %s de %s. La main correspondante lâche ce qu'elle tenait. +1 Traumatisme [i]Fracture (Mineure)[/i]. +1 État [i]Sonné[/i] en cas d'échec à un Test de [i]Résistance (Complexe)[/i].",H,J)elseif O >= 56 and O <= 60 then P="Ligament rompu"Q=3 R=string.format("%s lâche immédiatement ce qu'il tenait dans la main de son %s. +1 Traumatisme [i]Déchirure musculaire (Majeure)[/i]",J,H)elseif O >= 61 and O <= 65 then P="Coupure profonde"Q=3 R=string.format("+2 États [i]Hémorragique[/i] dûs à la forte mutilation du %s de %s. +1 État [i]Sonné[/i], +1 Traumatisme [i]Déchirure musculaire (Mineure)[/i], +1 État [i]Inconscient[/i] en cas d'échec à un Test de [i]Résistance (Difficile)[/i].",H,J)elseif O >= 66 and O <= 70 then P="Artère endommagée"Q=4 R=string.format("+4 États [i]Hémorragique[/i]. Jusqu'à ce que %s soit soigné par Chirurgie afin de recoudre la blessure, tout nouveau Dégât au %s redonnera +2 État [i]Hémorragique[/i], la blessure s'étant réouverte.",J,H)elseif O >= 71 and O <= 75 then P="Coude fracassé"Q=4 R=string.format("le coup fracasse le coude du %s de %s, faisant voler en éclats os et cartilage. %s lâche immédiatement ce qu'il tenait dans cette main, et subit +1 Traumatisme [i]Fracture (Majeure)[/i]",H,J,J)elseif O >= 76 and O <= 80 then P="Épaule luxée"Q=4 R=string.format("le %s de %s est démis de son logement. %s lâche immédiatement ce qu'il tenait dans cette main. +1 État [i]Sonné[/i] et +1 État [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Difficile)[/i]. +1 État [i]Sonné[/i] conservé jusqu'à bénéficier d'Aide Médicale. Un Test Étendu de Guérison avec 6 DR est nécessaire pour recouvrer l'usage du bras. Les tests utilisant ce bras subissent une pénalité de -10 pendant 1D10 jours.",H,J,J)elseif O >= 81 and O <= 85 then P="Doigt sectionné"Q=4 R=string.format("%s voit un de ses doigts s'envoler. +1 États [i]Hémorragique[/i]. — [b]Amputation (Accessible)[/b].",J)elseif O >= 86 and O <= 90 then P="Main ouverte"Q=5 R=string.format("la main du %s de %s s'ouvre sous la puissance du coup. Un Doigt est perdu — [b]Amputation (Complexe)[/b]. +2 États [i]Hémorragique[/i] et +1 État [i]Sonné[/i]. Pour chaque Round sans Aide Médicale, un autre Doigt est perdu. Si tous les doigts sont perdus, la main est perdue. — [b]Amputation (Complexe)[/b]",H,J)elseif O >= 91 and O <= 93 then P="Biceps déchiqueté"Q=5 R=string.format("le coup sépare presque entièrement le biceps et le tendon de l'os du "..H .. " de %s, laissant une blessure effrayante dont le sang gicle jusque sur son adversaire. %s lâche immédiatement ce qu'il tenait dans cette main. +1 Traumatisme [i]Déchirure musculaire (Majeure)[/i], +2 États [i]Hémorragique[/i] et +1 État [i]Sonné[/i]",J)elseif O >= 94 and O <= 96 then P="Main mutilée"Q=5 R=string.format("la main du "..H .. " de %s n'est plus qu'un tas de chair hémorragique. La main est perdue — [b]Amputation (Difficile)[/b]. +2 États [i]Hémorragique[/i]. +1 État [i]Sonné[/i] et +1 État [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Difficile)[/i]",J)elseif O >= 97 and O <= 99 then P="Tendons coupés"Q=5 R=string.format("Les tendons sont sectionnés par la force du coup et le %s de %s est inutilisable — [b]Amputation (Difficile)[/b]. +3 États [i]Hémorragique[/i], +1 État [i]À terre[/i], +1 État [i]Sonné[/i]. +1 État [i]Inconscient[/i] en cas d'échec à un Test de [i]Résistance (Difficile)[/i]. ",H,J)elseif O==100 then P="Démembrement fatal"Q=666 R=string.format("le %s de %s est coupé, faisant gicler le sang des artères jusqu'à 1D3 mètres dans une direction aléatoire (voir [b]Dispersion[/b]). La mort de %s est instantanée, et son corps s'effondre sans vie.",H,J)end elseif H=="Corps"then if O >= 1 and O <= 10 then P="Rien qu'une égratignure !"Q=1 R=string.format("+1 État [i]Hémorragique[/i].")elseif O >= 11 and O <= 20 then P="Coup au ventre"Q=1 R=string.format("+1 État [i]Sonné[/i]. +1 État [i]À terre[/i] et vomissement en cas d'échec à un Test de [i]Résistance (Facile)[/i].")elseif O >= 21 and O <= 25 then P="Coup bas"Q=1 R=string.format("+3 États [i]Sonné[/i] en cas d'échec à un Test de [i]Résistance (Difficile)[/i].")elseif O >= 26 and O <= 30 then P="Torsion du dos"Q=1 R=string.format("+1 Traumatisme [i]Déchirure musculaire (Mineure)[/i]")elseif O >= 31 and O <= 35 then P="Souffle coupé"Q=2 R=string.format("+1 État [i]Sonné[/i]. +1 États [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Accessible)[/i]. Le mouvement de %s est réduit de moitié pendant 1D10 rounds, le temps de récupérer son souffle.",J)elseif O >= 36 and O <= 40 then P="Bleus aux côtes"Q=2 R=string.format("Tous les Tests basés sur l'Agilité sont effectués avec une pénalité de -10 pendant 1D10 jours.")elseif O >= 41 and O <= 45 then P="Clavicule tordue"Q=2 R=string.format("Choisissez un bras au hasard. La main correspondante lâche ce qu'elle tenait, et le bras reste inutilisable pendant 1D10 Rounds.")elseif O >= 46 and O <= 50 then P="Chairs déchirées"Q=2 R=string.format("+2 États [i]Hémorragique[/i].")elseif O >= 51 and O <= 55 then P="Côtes fracturées"Q=3 R=string.format("Le coup de %s fracture une ou plusieurs côtes à %s. +1 État [i]Sonné[/i], +1 Traumatisme [i]Fracture (Mineure)[/i].",I,J)elseif O >= 56 and O <= 60 then P="Blessure béante"Q=3 R=string.format("+3 États [i]Hémorragique[/i]. Jusqu'à ce que %s soit soigné par Chirurgie afin de recoudre la blessure, tout nouveau Dégât au %s redonnera +1 État [i]Hémorragique[/i], la blessure s'étant réouverte.",J,H)elseif O >= 61 and O <= 65 then P="Entaille douloureuse"Q=3 R=string.format("+2 États [i]Hémorragique[/i] et +1 État [i]Sonné[/i]. +1 États [i]Inconscient[/i] en cas d'échec à un Test Spectaculaire de [i]Résistance (Difficile)[/i], %s s'évanouissant sous l'effet de la douleur. Avec moins de 4DR, %s hurle de douleur.",J)elseif O >= 66 and O <= 70 then P="Dégâts artériels"Q=3 R=string.format("+4 États [i]Hémorragique[/i]. Jusqu'à ce que %s soit soigné par Chirurgie afin de recoudre la blessure, tout nouveau Dégât au %s redonnera +2 États [i]Hémorragique[/i], la blessure s'étant réouverte.",J,H)elseif O >= 71 and O <= 75 then P="Dos froissé"Q=4 R=string.format("Une douleur irradiante assaille %s lorsqu'il fait jouer les muscles de son dos. +1 Traumatisme [b]Déchirure musculaire (Majeure)[/b]",J)elseif O >= 76 and O <= 80 then P="Hanche fracturée"Q=4 R=string.format("+1 État [i]Sonné[/i] et +1 Traumatisme [b]Fracture (Mineure)[/b]. +1 États [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Intermédiaire)[/i].")elseif O >= 81 and O <= 85 then P="Blessure majeure au torse"Q=4 R=string.format("%s reçoit une blessure importante au torse, le coup arrache la peau, les muscles et les tendons. +4 États [i]Hémorragique[/i]. Jusqu'à ce que %s soit soigné par Chirurgie afin de recoudre la blessure, tout nouveau Dégât au torse redonnera +2 États [i]Hémorragique[/i], la blessure s'étant réouverte.",J)elseif O >= 86 and O <= 90 then P="Blessure au ventre"Q=4 R=string.format("+2 États [i]Hémorragique[/i], c'est une Blessure Purulente.")elseif O >= 91 and O <= 93 then P="Cage thoracique perforée"Q=5 R=string.format("+1 État [i]Sonné[/i] jusqu'à réception d'une Aide Médicale. +1 Traumatisme [b]Fracture (Majeure)[/b].")elseif O >= 94 and O <= 96 then P="Clavicule cassée"Q=5 R=string.format("+1 État [i]Inconscient[/i] jusqu'à réception d'une Aide Médicale. +1 Traumatisme [b]Fracture (Majeure)[/b].")elseif O >= 97 and O <= 99 then P="Hémorragie interne"Q=5 R=string.format("+1 État [i]Hémorragique[/i] jusqu'à réception d'une Chirurgie. %s contracte en outre une Infection Sanguine.")elseif O==100 then P="Éventré"Q=666 R=string.format("%s est littéralement coupé en deux, tout personnage situé à moins de 2 mètres est recouvert de sang.",J)end elseif H == "Jambe gauche"or H == "Jambe droite"then if O >= 1 and O <= 10 then P="Orteil contusionné"Q=1 R=string.format("Dans le feu de la bataille, %s se cogne l'orteil. Pénalité de -10 à tous les Tests d'Agilité en cas d'échec à un Test de [i]Résistance (Accessible)[/i]",J)elseif O >= 11 and O <= 20 then P="Cheville tordue"Q=1 R=string.format("%s se tord la cheville. Tous ses Tests d'Agilité subissent une pénalité de -10 pendant 1D10 Rounds",J)elseif O >= 21 and O <= 25 then P="Coupure mineure"Q=1 R=string.format("+1 État [i]Hémorragique[/i].")elseif O >= 26 and O <= 30 then P="Perte d'équilibre"Q=1 R=string.format("Dans le feu du combat, %s perd l'équilibre. +1 États [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Intermédiaire)[/i]",J)elseif O >= 31 and O <= 35 then P="Coup à la cuisse"Q=2 R=string.format("%s reçoit un coup violent sur le haut de la cuisse. +1 État [i]Hémorragique[/i]. +1 États [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Accessible)[/i].",J)elseif O >= 36 and O <= 40 then P="Cheville foulée"Q=2 R=string.format("%s se foule la cheville. +1 Traumatisme [i]Déchirure musculaire (Mineure)[/i]")elseif O >= 41 and O <= 45 then P="Genou tordu"Q=2 R=string.format("Le genou de %s pivote un peu trop. Tous ses Tests d'Agilité subissent une pénalité de -20 pendant 1D10 Rounds.")elseif O >= 46 and O <= 50 then P="Coupure à l'orteil"Q=2 R=string.format("+1 États [i]Hémorragique[/i]. Une fois la rencontre terminée, Perte de l'orteil en cas d'échec à un Test de [i]Résistance (Intermédiaire)[/i] — [b]Amputation (Complexe)[/b]")elseif O >= 51 and O <= 55 then P="Mauvaise coupure"Q=3 R=string.format("+2 États [i]Hémorragique[/i] en raison de la profonde blessure au niveau du tibia de %s. +1 État [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Intermédiaire)[/i].",J)elseif O >= 56 and O <= 60 then P="Genou méchamment tordu"Q=3 R=string.format("%s se tord méchamment le genou. +1 Traumatisme [i]Déchirure musculaire (Mineure)[/i].",J)elseif O >= 61 and O <= 65 then P="Jambe charcutée"Q=3 R=string.format("%s reçoit une blessure profonde au niveau de la hanche. +2 États [i]Hémorragique[/i], +1 État [i]À terre[/i] et +1 Traumatisme [i]Déchirure musculaire (Mineure)[/i]. +1 États [i]Sonné[/i] en cas d'échec à un Test Spectaculaire de [i]Résistance (Difficile)[/i].",J)elseif O >= 66 and O <= 70 then P="Cuisse lacérée"Q=3 R=string.format("L'arme de %s entaille profondément la cuisse de %s. +1 États [i]À terre[/i] en cas d'échec à un Test de [i]Résistance (Intermédiaire)[/i]. Jusqu'à ce que %s soit soigné par Chirurgie afin de recoudre la blessure, tout nouveau Dégât au %s redonnera +1 États [i]Hémorragique[/i], la blessure s'étant réouverte.",I,J,J,H)elseif O >= 71 and O <= 75 then P="Tendon rompu"Q=4 R=string.format("Le tendon de %s cède. +1 État [i]À terre[/i], +1 État [i]Sonné[/i]. +1 État [i]Inconscient[/i] en cas d'échec à un Test de [i]Résistance (Difficile)[/i]. La jambe de %s devient inutilisable. +1 Traumatisme [b]Déchirure musculaire (Majeure)[/b]",J,J)elseif O >= 76 and O <= 80 then P="Entaille au tibia"Q=4 R=string.format("L'arme de %s traverse littéralement la jambe de %s au niveau du genou. +1 État [i]À terre[/i], +1 État [i]Sonné[/i], +1 Traumatisme [b]Fracture (Mineure)[/b], +1 Traumatisme [b]Déchirure musculaire (Majeure)[/b].",I,J)elseif O >= 81 and O <= 85 then P="Genou cassé"Q=4 R=string.format("Le coup de %s atteint la rotule de %s, qui se brise sous l'impact. +1 État [i]Hémorragique[/i], +1 État [i]À terre[/i], +1 État [i]Sonné[/i], +1 Traumatisme [b]Fracture (Majeure)[/b] tandis que %s s'effondre au sol.",I,J,J)elseif O >= 86 and O <= 90 then P="Genou démis"Q=4 R=string.format("Le genou de %s se déboîte de son emplacement. +1 État [i]À terre[/i], +1 États [i]Sonné[/i] en cas d'échec à un Test de [i]Résistance (Difficile)[/i] et Aide Médicale nécessaire pour récupérer. Un Test Étendu de Guérison (Accessible) avec 6 DR est nécessaire pour remettre le genou en place et récupérer l'usage de la jambe. Mouvement réduit de moitié et pénalité de -10 pendant 1D10 jours à tous les tests utilisant cette jambe.",J)elseif O >= 91 and O <= 93 then P="Pied écrasé"Q=5 R=string.format("Le coup de %s explose le pied de %s. +2 États [i]Hémorragique[/i]. +1 État [i]À terre[/i] et perte d'un orteil en cas d'échec à un Test de [i]Résistance (Accessible)[/i], plus un orteil par DR en-dessous de 0 — [b]Amputation (Complexe)[/b]. Perte du pied dans les 1d10 jours à défaut de soin par Chirurgie.",I,J)elseif O >= 94 and O <= 96 then P="Pied sectionné"Q=5 R=string.format("Le pied de %s est sectionné au niveau de la cheville et atterrit 1D3 mètres plus loin dans une direction aléatoire. +3 États [i]Hémorragique[/i], +2 État [i]Sonné[/i], +1 État [i]À terre[/i].",J)elseif O >= 97 and O <= 99 then P="Tendon coupé"Q=5 R=string.format("Un des tendons principaux à l'arrière de la jambe de %s est sectionné, le faisant hurler de douleur alors qu'il s'effondre. +2 États [i]Hémorragique[/i], +2 État [i]Sonné[/i], +1 État [i]À terre[/i]. %s devine avec horreur qu'il vient de perdre l'usage de sa jambe.",J,J)elseif O==100 then P="Bassin fracassé"Q=666 R=string.format("Le coup de %s fracasse littéralement le bassin de %s, coupant une jambe et atteignant la seconde. %s meurt instananément sous le choc.",I,J,J)end end return L,M,P,Q,R end function y(H,I)if I[H]then return I[H]else return false end end function z(H)local I={}local J=string.match(H,".*(Enroulement).*")I["enroulement"]= J~=nil local K=string.match(H,".*(Poudre).*")I["poudre"]= K~=nil local L=string.match(H,".*Répétition%((%d*)%).*")I["repetition"]=L local M=string.match(H,".*(Assommante).*")I["assommante"]= M~=nil local N=string.match(H,".*(Défensive).*")I["defensive"]= N~=nil local O=string.match(H,".*(Devastatrice).*")I["devastatrice"]= O~=nil local P=string.match(H,".*(Empaleuse).*")I["empaleuse"]= P~=nil local Q=string.match(H,".*Explosion%((%d*)%).*")I["explosion"]=Q local R=string.match(H,".*(Immobilisante).*")I["immobilisante"]= R~=nil local S=string.match(H,".*(Incassable).*")I["incassable"]= S~=nil local T=string.match(H,".*(Percutante).*")I["percutante"]= T~=nil local U=string.match(H,".*(Perforante).*")I["perforante"]= U~=nil local V=string.match(H,".*(Perturbante).*")I["perturbante"]= V~=nil local W=string.match(H,".*(Piège-lame).*")I["piegeLame"]= W~=nil local X=string.match(H,".*(Pistolet).*")I["pistolet"]= X~=nil local Y=string.match(H,".*(Pointue).*")I["pointue"]= Y~=nil local Z=string.match(H,".*(Précise).*")I["precise"]= Z~=nil local ab=string.match(H,".*Protectrice%((%d*)%).*")I["protectrice"]= ab~=nil local bb=string.match(H,".*(Rapide).*")I["rapide"]= bb~=nil local cb=string.match(H,".*(Taille).*")I["taille"]= cb~=nil local db=string.match(H,".*(Dangereuse).*")I["dangereuse"]= db~=nil local eb=string.match(H,".*(Épuisante).*")I["epuisante"]= eb~=nil local fb=string.match(H,".*(Imprécise).*")I["imprecise"]= fb~=nil local gb=string.match(H,".*(Inoffensive).*")I["inoffensive"]= gb~=nil local hb=string.match(H,".*(Inoffensive).*")I["imprecise"]= hb~=nil local ib=string.match(H,".*(Lente).*")I["lente"]= ib~=nil local jb=string.match(H,".*Recharge%((%d*)%).*")I["recharge"]= jb~=nil return I end function A(H,I,J,K,L,M)H=string.lower(H)local N=""if H=="simple"then if J and K then local O= "Test Simple, difficulté "..n(K) .. ", maximum de " .. J local P= "["..'div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]' .. L .. "[" .. "/div]"P= P.."[" .. 'div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]' .. M .. "[" .. "/div]"local Q=h(L,M)local R=i(Q,J)local S=k(H,L,M)local T=""if R==true then T="Succès"else T="Échec"end local U=""if S==true then U="Critique"else U=""end local V=string.format("%d contre %d est un %s %s",Q,J,T,U)local W=""if R and not S then W=string.format("L'action du personnage est [u]une réussite[/u].")elseif R and S then W=string.format("L'action du personnage est [u]une réussite stupéfiante !![/u]")elseif not R and not S then W=string.format("L'action du personnage est clairement [u]un échec[/u].")elseif not R and S then W=string.format("L'action du personnage est [u]un échec stupéfiant ![/u] Le personnage échoue lamentablement, tout est allé de travers et les conséquences de cet échec sont catastrophiques !")end return rpg.smf.save(O,P,V,W,"wfrp4")end elseif H=="spectaculaire"then if J and K then local O= "Test Spectaculaire, difficulté "..n(K) .. ", maximum de " .. J local P= '[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'..L .. "[/div]"P= P..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]' .. M .. "[/div]"local Q=h(L,M)local R=i(Q,J)local S=k(H,L,M)local T=r(Q,J)T= T+s(I)local U=""local V=""local W=""if R==true then if S then N=string.format("%d contre %d donne un Succès avec %d Degrés de Réussite, mais c'est surtout un jet Critique, obtenant ainsi un Succès Stupéfiant !",Q,J,T)W="Grâce à ce jet de dés critique, l'action du personnage est un [u]Succès Stupéfiant[/u] ! Les résultats dépassent ce qu'il espérait, on n'aurait pas pu imaginer mieux !"else if T>=6 then N=string.format("%d contre %d donne un Succès avec %d Degrés de Réussite, ce qui est un [u]Succès Stupéfiant[/u] !",Q,J,T)W="L'action du personnage est une [u]réussite stupéfiante[/u] ! Les résultats dépassent ce qu'il espérait, on n'aurait pas pu imaginer mieux !"elseif T == 4 or T == 5 then N=string.format("%d contre %d donne un Succès avec %d Degrés de Réussite, ce qui est un [u]Succès Impressionnant[/u] !",Q,J,T)W="L'action du personnage est [u]réussie avec style[/u] et les résultats sont absolument parfaits."elseif T == 2 or T == 3 then N=string.format("%d contre %d donne un Succès avec %d Degrés de Réussite",Q,J,T)W="L'action du personnage est [u]une réussite[/u]."elseif T == 0 or T == 1 then N=string.format("%d contre %d est un Succès mais avec %d Degré de Réussite, c'est un [u]Succès Minime[/u]...",Q,J,T)W="L'action du personnage est [u]plus ou moins réussie[/u], mais ce n'est pas parfait et des effets inattendus sont possibles."end end elseif R==false then if S then N=string.format("%d contre %d donne un Échec avec %d Degrés de Réussite, mais c'est surtout un jet Critique, obtenant ainsi un Échec Stupéfiant !",Q,J,T)W="L'action du personnage est [u]un Échec Stupéfiant ![/u] Le personnage échoue lamentablement, tout est allé de travers et les conséquences de cet échec sont catastrophiques !"else if T<=-6 then N=string.format("%d contre %d donne un Échec avec %d Degrés de Réussite, ce qui est un [u]Échec Stupéfiant[/u] !",Q,J,T)W="L'action du personnage est [u]un Échec Stupéfiant ![/u] Le personnage échoue lamentablement, tout est allé de travers et les conséquences de cet échec sont catastrophiques !"elseif T == -4 or T == -5 then N=string.format("%d contre %d donne un Échec avec %d Degrés de Réussite, ce qui est un [u]Échec Impressionnant[/u] !",Q,J,T)W="L'action du personnage est un [u]échec complet[/u], amenant même quelques conséquences collatérales négatives."elseif T == -2 or T == -3 then N=string.format("%d contre %d donne un Échec avec %d Degrés de Réussite.",Q,J,T)W="L'action du personnage est clairement [u]un échec[/u]."elseif T == 0 or T == -1 then N=string.format("%d contre %d donne un Échec mais avec %d Degrés de Réussite, c'est un [u]Échec Minime[/u]...",Q,J,T)W="L'action du personnage [u]échoue de peu[/u], avec peut-être des progrès mineurs ou la possibilité de retenter sa chance au prochain Round, si la situation s'y prête."end end end local X=N local Y=W return rpg.smf.save(O,P,X,Y,"wfrp4")end else return rpg.smf.save("Type de test inconnu","myrolls","myresults","myfooter","wfrp4")end end function B(H,I,J,K,L,M,N,O,P,Q,R,S)local T=""local U= H or"Protagoniste 1"local V= N or"Protagoniste 2"T= T..'[div style="display: flex; color: white"]'T= T..'[div style="display: flex; flex-direction: column; width: 100%"]'T= T..'[span style="font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px"]'T= T.."Test Opposé"T= T.."[/span]"T= T..'[div style="display: flex; width: 100%"]'T= T..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'T= T..'[div style="display: flex; font-weight: bold"]'T= T..U T= T.."[/div]"T= T..'[div style="display: flex"]'T= T.."Seuil de base : " .. I T= T.."[/div]"T= T..'[div style="display: flex"]'T= T.."Difficulté " .. n(K) .. " (" .. o(K) .. ")"T= T.."[/div]"T= T..'[div style="display: flex"]'T= T.."Maximum : " .. J T= T.."[/div]"T= T.."[/div]"T= T..'[hr style="border: color; margin: 5px"]'T= T..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'T= T..'[div style="display: flex; font-weight: bold"]'T= T..V T= T.."[/div]"T= T..'[div style="display: flex"]'T= T.."Seuil de base : " .. O T= T.."[/div]"T= T..'[div style="display: flex"]'T= T.."Difficulté " .. n(Q) .. " (" .. o(Q) .. ")"T= T.."[/div]"T= T..'[div style="display: flex"]'T= T.."Maximum : " .. P T= T.."[/div]"T= T.."[/div]"T= T.."[/div]"T= T.."[/div]"T= T.."[/div]"local W=""W= W..'[div style="display: flex"]'W= W..'[div style="display: flex; flex-grow: 1; justify-content: center"]'W= W..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'W= W..L W= W.."[/div]"W= W..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'W= W..M W= W.."[/div]"W= W.."[/div]"W= W..'[hr style="border: color; margin: 5px"]'W= W..'[div style="display: flex; flex-grow: 1; justify-content: center"]'W= W..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'W= W..R W= W.."[/div]"W= W..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'W= W..S W= W.."[/div]"W= W.."[/div]"W= W.."[/div]"local X=h(L,M)local Y=h(R,S)local Z=i(X,J)local ab=i(Y,P)local bb=k("oppose",L,M)local cb=k("oppose",R,S)local db=r(X,J)local eb=r(Y,P)local fb=""local gb=""local hb=""local ib=""local jb=""local kb=""local lb=""local mb=""if bb then jb="Critique"if(db >= 0 and db < 6)then db=6 elseif(db <= 0 and db > -6)then db=-6 end end if cb then kb="Critique"if(eb >= 0 and eb < 6)then eb=6 elseif(eb <= 0 and eb > -6)then eb=-6 end end db= db+s(I)eb= eb+s(O)if Z then fb="Succès"else fb="Échec"end if ab then gb="Succès"else gb="Échec"end hb=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",fb,jb,db)ib=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",gb,kb,eb)local nb=""nb= nb..'[div style="display: flex"]'nb= nb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'nb= nb..'[span class="" style="color: white"]'nb= nb..hb nb= nb.."[/span]"nb= nb.."[/div]"nb= nb..'[hr style="border: color; margin: 5px"]'nb= nb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'nb= nb..'[span class="" style="color: white"]'nb= nb..ib nb= nb.."[/span]"nb= nb.."[/div]"nb= nb.."[/div]"local ob=""local pb=""local qb=""if(db > eb and true)then qb=string.format("[u]%s remporte le Test[/u][br/]avec %d Degrés de Réussite d'écart.",U, db-eb)ob=U pb=V elseif(db < eb and true)then qb=string.format("[u]%s remporte le Test[/u][br/]avec %d Degrés de Réussite d'écart.",V, eb-db)ob=V pb=U elseif(db == eb and true)then if Z and not ab then qb=string.format("[u]%s remporte le Test[/u], départagé par le Succès du lancer",U)ob=U pb=V elseif ab and not Z then qb=string.format("[u]%s remporte le Test[/u], départagé par le Succès du lancer.",V)ob=V pb=U elseif(Z and Z)or(not Z and not ab)then if J>P then qb=string.format("[u]%s remporte le Test de peu[/u], départagé par le Seuil du Test.",U)ob=U pb=V elseif(J < P and true)then qb=string.format("[u]%s remporte le Test[/u], départagé par le Seuil du Test.",V)ob=V pb=U elseif(J == P and true)then if I>O then qb=string.format("[u]%s remporte le Test[/u], départagé par le Score de compétence.",U)ob=U pb=V elseif(I < O and true)then qb=string.format("[u]%s remporte le Test[/u], départagé par le Score de compétence.",V)ob=V pb=U elseif(I == O and true)then if(X < Y and true)then qb=string.format("[u]%s remporte le Test[/u], départagé par le Lancer de dé.",U)ob=U pb=V elseif(X > X and true)then qb=string.format("[u]%s remporte le Test[/u], départagé par le Lancer de dé.",V)ob=V pb=U elseif(X == Y and true)then qb=string.format("[u]Aucun protagoniste ne remporte le Test, c'est une égalité parfaite[/u].")end end end end end local rb=""if Z and ab then rb= rb..string.format( "Les deux protagonistes ont réussi, mais %s a tout de même pris le dessus sur %s.", ob, pb )elseif(Z and not ab)or(ab and not Z)then rb= rb..string.format("Le résultat est clair, sans ambigüité : %s a réussi et %s a échoué.", ob, pb)elseif not Z and not ab then rb= rb.."Toutefois, les deux protagonistes ont échoué, quel duel de bras cassés !"end local sb=""sb= sb..'[hr style="border: color; margin: 5px; "]'sb= sb..'[div style="display: flex;margin-top: 10px"]'sb= sb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'sb= sb..'[div style="color: white"]'sb= sb..'[div style="color: white; font-size: 1.2em; font-weight: bold; padding-bottom:5px; line-height: 1.4em"]' .. qb .. "[/div]"sb= sb..'[div style="color: white; font-weight: bold; padding-top:5px"]' .. rb .. "[/div]"sb= sb.."[/div]"sb= sb.."[/div]"sb= sb.."[/div]"return rpg.smf.save(T,W,nb,sb,"wfrp4")end function C(H)if _VERSION=="Lua 5.1"then return unpack(H)elseif _VERSION == "Lua 5.2" or _VERSION == "Lua 5.3"or _VERSION == "Lua 5.4"then return table.unpack(H)end end function D(H)print("EvaluateTestCorpsACorps")local I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z=C(H)local ab=""local bb= I or"Protagoniste 1"local cb= R or"Protagoniste 2"local db=""ab= ab..'[div style="display: flex; color: white"]'ab= ab..'[div style="display: flex; flex-direction: column; width: 100%"]'ab= ab..'[span style="font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px"]'ab= ab.."Attaque au Corps-à-Corps"ab= ab.."[/span]"ab= ab..'[div style="display: flex; width: 100%"]'ab= ab..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'ab= ab..'[div style="display: flex; font-weight: bold"]'ab= ab.."Attaquant"ab= ab.."[/div]"ab= ab..'[div style="display: flex; font-weight: bold"]'ab= ab..bb ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Seuil de base : " .. J ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Difficulté " .. n(L) .. " (" .. o(L) .. ")"ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab..M .. " Avantages (" .. p(M) .. ")"ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Seuil effectif : " .. K ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Bonus de Force : " .. P ab= ab.."[/div]"if#Q>0 then ab= ab..'[div style="display: flex"]'ab= ab.."[span]Atouts d'Arme : [/span]"for Pb,Qb in pairs(Q)do if(Qb)then ab= ab..'[span]' .. Qb .. '[/span]'end end ab= ab.."[/div]"end ab= ab.."[/div]"ab= ab..'[hr style="border: color; margin: 5px"]'ab= ab..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'ab= ab..'[div style="display: flex; font-weight: bold"]'ab= ab.."Défenseur"ab= ab.."[/div]"ab= ab..'[div style="display: flex; font-weight: bold"]'ab= ab..cb ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Seuil de base : " .. S ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Niveau " .. n(U) .. " (" .. o(U) .. ")"ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab..V .. " Avantages (" .. p(V) .. ")"ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Seuil effectif : " .. T ab= ab.."[/div]"ab= ab..'[div style="display: flex"]'ab= ab.."Bonus d'Endurance : " .. Y ab= ab.."[/div]"ab= ab.."[/div]"ab= ab.."[/div]"ab= ab.."[/div]"ab= ab.."[/div]"local eb=""eb= eb..'[div style="display: flex"]'eb= eb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'eb= eb..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'eb= eb..N eb= eb.."[/div]"eb= eb..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'eb= eb..O eb= eb.."[/div]"eb= eb.."[/div]"eb= eb..'[hr style="border: color; margin: 5px"]'eb= eb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'eb= eb..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'eb= eb..W eb= eb.."[/div]"eb= eb..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'eb= eb..X eb= eb.."[/div]"eb= eb.."[/div]"eb= eb.."[/div]"local fb=h(N,O)local gb=h(W,X)local hb=i(fb,K)local ib=i(gb,T)local jb=k("corps-a-corps",N,O)local kb=k("corps-a-corps",W,X)local lb=r(fb,K)local mb=r(gb,T)local nb=""local ob=""local pb=""local qb=""local rb=""local sb=""local tb=""local ub=""local vb=""if jb then pb="Critique"end if kb then qb="Critique"end lb= lb+s(J)mb= mb+s(S)if hb then nb="Succès"else nb="Échec"end if ib then ob="Succès"else ob="Échec"end rb=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",nb,pb,lb)sb=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",ob,qb,mb)local wb=""wb= wb..'[div style="display: flex"]'wb= wb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'wb= wb..'[span class="" style="color: white"]'wb= wb..rb wb= wb.."[/span]"wb= wb.."[/div]"wb= wb..'[hr style="border: color; margin: 5px"]'wb= wb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'wb= wb..'[span class="" style="color: white"]'wb= wb..sb wb= wb.."[/span]"wb= wb.."[/div]"wb= wb.."[/div]"local xb=""local yb=""local zb=""local Ab=""local Bb=""local Cb=""local Db=0 local Eb=0 local Fb=""local Gb=""local Hb=0 local Ib=0 local Jb=0 local Kb=0 if jb then zb=u(rpg.roll.dice(1,1,100)[1])Hb,Ib,Bb,Db,Fb=x(zb,bb,cb)else zb=u(fb)Bb=v(zb)end if kb then Ab=u(rpg.roll.dice(1,1,100)[1])Jb,Kb,Cb,Eb,Gb=x(Ab,cb,bb)end if(hb and jb)then ub= ub..string.format( "[u]%s porte un Coup Critique[/u] touchant %s avec pour effet [b]%s[/b]. Le coup fait perdre directement %d Points de Blessure, avec des effets supplémentaires : %s", bb, cb, Bb, Db, Fb )end if(ib and kb)then vb= vb..string.format( "[u]En se défendant de l'attaque de %s, %s réussit un Coup Critique[/u] avec pour effet [b]%s[/b]. Le coup outrepasse l'armure éventuelle, et occasionne directement %d Dégâts, avec les effets supplémentaires suivants : %s", bb, cb, Cb, Eb, Gb )end tb= ub.."[br/]" .. vb .. "[br/]"local Lb,Mb=t(lb,P,mb,Y,"+BF +3",Q)if(lb > mb and true)then print(Lb,Bb)tb= tb..string.format( "[u]%s attaque avec succès[/u]. Il touche %s %s et occasionne des Dégâts à hauteur de " .. Mb .. " = %d Points de Blessure", bb, cb, Ab, Lb )xb=bb yb=cb elseif(lb < mb and true)then tb= tb..string.format( "[u]%s remporte le Test[/u][br/]avec %d Degrés de Réussite d'écart.", cb, mb - lb )xb=cb yb=bb elseif(lb == mb and true)then if hb and not ib then tb= tb..string.format("[u]%s remporte le Test[/u], départagé par le Succès du lancer. Il touche %s %s et occasionne des Dégâts à hauteur de " .. Mb .. " = %d Points de Blessure", bb, cb, Ab, Lb )xb=bb yb=cb elseif ib and not hb then tb= tb..string.format("[u]%s remporte le Test[/u], départagé par le Succès du lancer.", cb)xb=cb yb=bb elseif(hb and hb)or(not hb and not ib)then if(K > T and true)then tb= tb..string.format( "[u]%s remporte le Test de peu[/u], départagé par le Seuil du Test. Il touche %s %s et occasionne des Dégâts à hauteur de " .. Mb .. " = %d Points de Blessure", bb, cb, Ab, Lb )xb=bb yb=cb elseif(K < T and true)then tb= tb..string.format("[u]%s remporte le Test[/u], départagé par le Seuil du Test.", cb)xb=cb yb=bb elseif(K == T and true)then if J>S then tb= tb..string.format( "[u]%s remporte le Test[/u], départagé par le Score de compétence. Il touche %s %s et occasionne des Dégâts à hauteur de " .. Mb .. " = %d Points de Blessure", bb, cb, Ab, Lb )xb=bb yb=cb elseif(J < S and true)then tb= tb..string.format( "[u]%s remporte le Test[/u], départagé par le Score de compétence.", cb )xb=cb yb=bb elseif(J == S and true)then if(fb < gb and true)then tb= tb..string.format( "[u]%s remporte le Test[/u], départagé par le Lancer de dé. Il touche %s %s et occasionne des Dégâts à hauteur de " .. Mb .. " = %d Points de Blessure", bb, cb, Ab, Lb )xb=bb yb=cb elseif(fb > gb and true)then tb= tb..string.format( "[u]%s remporte le Test[/u], départagé par le Lancer de dé.", cb )xb=cb yb=bb elseif(fb == gb and true)then tb= tb..string.format("[u]Aucun protagoniste ne remporte le Test, c'est une égalité parfaite[/u].")end end end end end local Nb=""if hb and ib then Nb= Nb..string.format( "Les deux protagonistes ont réussi, mais %s a tout de même pris le dessus sur %s.", xb, yb )elseif(hb and not ib)then Nb= Nb..string.format("Le résultat est clair, sans ambigüité : %s a réussi et %s a échoué.", xb, yb)elseif(ib and not hb)then Nb= Nb..string.format("Le résultat est clair, sans ambigüité : %s a réussi et %s a échoué.", xb, yb)elseif not hb and not ib then Nb= Nb.."Toutefois, les deux protagonistes ont échoué, quel duel de bras cassés !"end local Ob=""Ob= Ob..'[hr style="border: color; margin: 5px; "]'Ob= Ob..'[div style="display: flex;margin-top: 10px"]'Ob= Ob..'[div style="display: flex; flex-grow: 1; justify-content: center"]'Ob= Ob..'[div style="color: white"]'Ob= Ob..'[div style="color: white; font-size: 1.2em; font-weight: bold; padding-bottom:5px; line-height: 1.4em"]' .. tb .. "[/div]"Ob= Ob..'[div style="color: white; font-weight: bold; padding-top:5px"]' .. Nb .. "[/div]"Ob= Ob.."[/div]"Ob= Ob.."[/div]"Ob= Ob.."[/div]"return rpg.smf.save(ab,eb,wb,Ob,"wfrp4")end function E(H)local I={}I["Player"]="Player"I["Name"]="Name"I["Nom"]="b2_l1_f1i"I["Art"]="b12_l2_f5i"I["Athlétisme"]="b12_l3_f5i"I["Calme"]="b12_l4_f5i"I["Charme"]="b12_l5_f5i"I["Chevaucher"]="b12_l6_f5i"I["Corps à corps (base)"]="b12_l7_f5i"I["Corps à corps"]="b12_l8_f5i"I["Commandement"]="b12_l9_f5i"I["Conduite d'attelage"]="b12_l10_f5i"I["Discrétion"]="b12_l11_f5i"I["Divertissement"]="b12_l12_f5i"I["Emprise sur les animaux"]="b12_l13_f5i"I["Escalade"]="b12_l14_f5i"I["Esquive"]="b13_l2_f5i"I["Intimidation"]="b13_l3_f5i"I["Intuition"]="b13_l4_f5i"I["Marchandage"]="b13_l5_f5i"I["Orientation"]="b13_l6_f5i"I["Pari"]="b13_l7_f5i"I["Perception"]="b13_l8_f5i"I["Ragot"]="b13_l9_f5i"I["Ramer"]="b13_l10_f5i"I["Résistance"]="b13_l11_f5i"I["Résistance à l'alcool"]="b13_l12_f5i"I["Subornation"]="b13_l13_f5i"I["Survie en extérieur"]="b13_l14_f5i"local J=I[H]return I[H]end function G(H)print("analyseChaineTest(s)",H)local I={}I['idPersonnage']=string.match(H,".*ID%((%d-)%).*")I['competence']=string.match(H,".*Competence%((.-)%).*")I['difficulte']=string.match(H,".*Difficulté%((.-)%).*")return I end function rpg.accel.ask(H)print("ask",H)local I={}I['simple']="Simple"I['spectaculaire']="Spectaculaire"I['oppose']="Opposé"I['corps-a-corps']="Corps à Corps"I['distance']="Combat à distance"local J=string.match(H,"test[%s]*([%w%p]*).*")local K,L,M="[b]Ton Vénéré MJ te demande de réaliser un Test[/b]", ":"..H .. ":","wfrp4-ask"local N local O=I[J]print(string.format("ask typetest == %s",J))print(string.format("ask labelTypeTest == %s",O))if J == "simple"or J == "spectaculaire"then local Q=G(H)local R=Q['idPersonnage']local S=Q['competence']local T=rpg.character.getfield(R,E(S))local U=Q['difficulte']local V=n(U)local W=l(m(U))local X=rpg.character.getfield(R,E('Nom'))local Y= T+W local Z=rpg.character.getfield(R,E('Player'))N=string.format("[br/]C'est un Test %s de %s (%d), Difficulté %s (%d).[br/]Le seuil est donc de %d pour %s ! Fais chauffer tes dés, %s !",O,S,T,V,W,Y,X,Z)elseif J=="oppose"then local Q={}Q[1]=string.match(H,"(.*)/.*")Q[2]=string.match(H,".*/%s*(.*)%s*")local R={}for ib,jb in pairs(Q)do if(jb)then table.insert(R,G(jb))end end local S=R[1]['idPersonnage']local T=R[2]['idPersonnage']local U=R[1]['competence']local V=R[2]['competence']local W= rpg.character.getfield(S,E(U))or nil local X= rpg.character.getfield(T,E(V))or nil local Y= R[1]['difficulte']or"I"local Z= R[2]['difficulte']or"I"local ab=n(Y)local bb=n(Z)local cb=l(m(Y))local db=l(m(Z))local eb=rpg.character.getfield(S,E('Nom'))local fb=rpg.character.getfield(T,E('Nom'))local gb= W+cb local hb= X+db N=string.format("[br/]C'est un Test Opposé :[br/]%s : %s(%d, %s = %d)[br/]contre[br/]%s : %s(%d, %s = %d)!",eb,U,W,ab,gb,V,fb,X,bb,hb)elseif J=="corps-a-corps"then O="Corps à corps"elseif J=="distance"then O="Combat à distance"else return end local P="[br/]Commande à copier dans un message :"return rpg.smf.save(K,N,P,L,M)end function rpg.accel.test(H)print("s",H)local I,J=rpg.smf.striptitle(H)local K=string.match(H,"^([%w%p]*).*")print("typetest",K)local L,M,N=string.match(H,"[%w%p]*[%s]*ID%(([%d]*)%)[%s]*Competence%((.*)%)[%s]*Difficulté%((.*)%)")local O= L or false local P= L~=nil local Q=tonumber(0)K= tostring(K)or""local R if((K == "simple" or K == "spectaculaire")and true)then if P then local X=rpg.character.getfield(O,E(M))Q=tonumber(rpg.character.getfield(O,E(M)))local Y=rpg.character.getfield(O,E('Nom'))local Z=n(N)local ab=l(m(N))local bb= X+ab else local X,Y=string.match(H,"%w*[%s]*(%d*)[%s]*(%w*)[%s]*")end N=m(tostring(N)or"")local S=l(N)local T=q(Q,S)local U=rpg.roll.dice(2,0,9)local V=U[1]local W=U[2]R=A(K,Q,T,N,V,W)elseif(K == "oppose"and true)then local S,T,U=string.match(H,"[%w%p]*[%s]*ID%(([%d]*)%)[%s]*Competence%((.*)%)[%s]*Difficulté%((.*)%)")local V,W,X=string.match(H,".*/*[%s]*ID%(([%d]*)%)[%s]*Competence%((.*)%)[%s]*Difficulté%((.*)%)")local Y= S or false local Z= V or false local ab= S~=nil local bb= V~=nil local cb,db,eb,fb,gb,hb=string.match(H,"%w*[%s]+([%w%p]*)[%s]+(%d+)[%s]+([%w]*)[%s]*/[%s]*([%w%p]+)[%s]*(%d+)[%s]*([%w]*)")db= tonumber(db)or nil gb= tonumber(gb)or nil if(eb == ""and true)then eb="I"end if(hb == ""and true)then hb="I"end eb=m(eb)hb=m(hb)local ib=l(eb)local jb=l(hb)local kb=q(db,ib)local lb=q(gb,jb)local mb=rpg.roll.dice(2,0,9)local nb=rpg.roll.dice(2,0,9)local ob=mb[1]local pb=nb[1]local qb=mb[2]local rb=nb[2]local sb=i(h(ob,qb),kb)local tb=i(h(pb,rb),lb)local ub=j(h(ob,qb),kb)local vb=j(h(pb,rb),lb)local wb=k(K,ob,qb)local xb=k(K,pb,rb)R=B(cb,db,kb,eb,ob,qb,fb,gb,lb,hb,pb,rb)elseif(K == "corps-a-corps"and true)then local S,T,U,V,W=string.match(H,"%w*[%s]+([%a%p%s]*)[%s]+(%d+)[%s]+([%w]*)[%s]*(%d*)A[%s]*(%d*)BF[%s]*.*/.*")local X=z(string.match(H,"(.*)/"))local Y=string.match(H,".*/%s*(.*)")print("protagoniste2S",Y)local Z,ab,bb,cb,db=string.match(Y,"([%a%p%s]*)(%d+)[%s]*([%w]*)[%s]*(%d*)A[%s]*(%d*)BE[%s]*")print(Z,ab,bb,cb,db)T= tonumber(T)or nil ab= tonumber(ab)or nil V= tonumber(V)or 0 cb= tonumber(cb)or 0 W= tonumber(W)or 0 db= tonumber(db)or 0 if(U == ""and true)then U="I"end if(bb == ""and true)then bb="I"end U=m(U)bb=m(bb)local eb=l(U)local fb=l(bb)local gb=q(T,eb)local hb=q(ab,fb)gb= gb+(V * 10)hb= hb+(cb * 10)local ib=rpg.roll.dice(2,0,9)local jb=rpg.roll.dice(2,0,9)local kb=ib[1]local lb=jb[1]local mb=ib[2]local nb=jb[2]local ob=z(string.match(H,".*/(.*)"))local pb=i(h(kb,mb),gb)local qb=i(h(lb,nb),hb)local rb=j(h(kb,mb),gb)local sb=j(h(lb,nb),hb)local tb=k(K,kb,mb)local ub=k(K,lb,nb)R=D({S,T,gb,U,V,kb,mb,W,X,Z,ab,hb,bb,cb,lb,nb,db,ob})elseif(K == "distance"and true)then print("Test d'Attaque à distance:",K)else print("Test de type inconnu:",K)end return R end