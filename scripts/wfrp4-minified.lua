a=true b=1 c=97 d=true e=true f=0.5 g=6921 function h(U,V)if(U == V and true)then return true else return false end end local function S(U,V,W,X,Y)local function Z(bb,cb,db,eb,fb)local gb= "["..cb if fb then gb= gb..' id="' .. fb .. '"'end if db then gb= gb..' class="' .. db .. '"'end if eb then gb= gb..' style="' .. eb .. '"'end return gb.."]" .. bb .. "[/" .. cb .. "]"end local ab=Z(U,V,W,X,Y)return function(bb,cb,db,eb)if not bb then return ab else return S(ab,bb,cb,db,eb)end end end local function T(U,V,W,X,Y)local Z={tagName= U or"",children={},isTextNode=false}local ab=""if W then ab= ab..' id="' .. W .. '"'end if X then ab= ab..' class="' .. X .. '"'end if Y then ab= ab..' style="' .. Y .. '"'end Z.tagAttributes=ab function Z.addChild(bb,cb,db,eb,fb)local gb=T(bb,cb,db,eb,fb)table.insert(Z.children,gb)return gb end if V and U then Z.addChild(nil,V)elseif V and not U then Z.isTextNode=true Z.text=V end function Z.build()local bb=""if Z.isTextNode then return Z.text else if Z.tagName~=""then bb= "["..Z.tagName if Z.tagAttributes~=""then bb= bb..Z.tagAttributes end bb= bb.."]"end for cb,db in ipairs(Z.children)do bb= bb..db.build()end if Z.tagName~=""then if Z.tagName=="hr"then else bb= bb.."[/" .. Z.tagName .. "]"end end end return bb end return Z end function i(U,V)if U == 0 and V == 0 then return 100 else return U * 10+V end end function j(U,V)if(U <= V or (a and U <= b))and not (a and U >= c)then return true else return false end end function k(U,V)if U >= V or U >= c then return true else return false end end function l(U,V,W)if(d and h(V, W))or((U ~= "corps-a-corps" or U ~= "distance") and a and (i(V, W) <= b or i(V, W) >= c))then return true else return false end end function m(U)U= string.lower(U)or"I"local V,W,X,Y,Z,ab,bb,cb={},60,40,20,0,-10,-20,-30 V["tf"]=W V["f"]=X V["a"]=Y V["i"]=Z V["c"]=ab V["d"]=bb V["td"]=cb return V[U]end function n(U)U=string.lower(U)local V,W,X,Y,Z,ab,bb,cb={},"TF","F","A","I","C","D","TD"V["tf"]=W V["tresfacile"]=W V["f"]=X V["facile"]=X V["a"]=Y V["accessible"]=Y V["i"]=Z V["intermediaire"]=Z V["intermédiaire"]=Z V["c"]=ab V["complexe"]=ab V["d"]=bb V["difficile"]=bb V["td"]=cb V["tresdifficile"]=cb return V[U]end function o(U)U=string.lower(U)local V,W,X,Y,Z,ab,bb,cb={},"Très Facile","Facile","Accessible","Intermédiaire","Complexe","Difficile","Très Difficile"V["tf"]=W V["tresfacile"]=W V["f"]=X V["facile"]=X V["a"]=Y V["accessible"]=Y V["i"]=Z V["intermediaire"]=Z V["intermédiaire"]=Z V["c"]=ab V["complexe"]=ab V["d"]=bb V["difficile"]=bb V["td"]=cb V["tresdifficile"]=cb return V[U]end function p(U)U=string.lower(U)local V,W,X,Y,Z,ab,bb,cb={},"+60","+40","+20","+0","-10","-20","-30"V["tf"]=W V["tresfacile"]=W V["f"]=X V["facile"]=X V["a"]=Y V["accessible"]=Y V["i"]=Z V["intermediaire"]=Z V["intermédiaire"]=Z V["c"]=ab V["complexe"]=ab V["d"]=bb V["difficile"]=bb V["td"]=cb V["tresdifficile"]=cb return V[U]end function q(U)U=tonumber(U)if U<=0 then return"+0"elseif U>0 then return"+"..U * 10 end end function r(U,V)local W= U+V if(W < 1 and true)then W=1 end return W end function s(U,V)local W= (V - U)/10 local X=0 if(W > 0 and true)then X=math.floor(W)elseif(W < 0 and true)then X=math.ceil(W)end X= X+t(V)return X end function t(U)U=tonumber(U)local V=0 if e then if(U > 100 and true)then V=math.floor((U - 100)/10)end else V=0 end return V end function u(U,V,W,X,Y,Z)local ab=0 local bb= U-W local cb,db=string.match(Y,".*(%+BF)%s*(%+%d*)")cb= cb~=nil db=tonumber(db)if cb then db= db+V else db=db end ab= db+bb local eb=string.format("%dDR %s",bb,Y)local fb=""if(f < 1 and not Z["inoffensive"]and true)then ab= ab-math.ceil(X * f)fb=string.format(" - (%dBE * %.1f)",X,f)else ab= ab-X fb=string.format(" - %dBE",X)end eb= eb..fb if(ab < 0 and true)then ab=0 end return ab,eb end function v(U,V)for W,X in ipairs(V)do if U >= X[1]and U <= X[2]then return X[3]end end return end function w(U)U=tonumber(U)local V={{1,9,"Tête"},{21,41,"Bras secondaire"},{25,44,"Bras principal"},{45,79,"Corps"},{80,89,"Jambe gauche"},{90,100,"Jambe droite"}}return v(U,V)end function x(U)local V={}local W="LibLocDegats"U["tête"]=y(W.."Tete")U["bras secondaire"]=y(W.."BrasG")U["bras principal"]=y(W.."BrasD")U["corps"]=y(W.."Corps")U["jambe gauche"]=y(W.."JambeG")U["jambe droite"]=y(W.."JambeD")return U[U]end function z(U,V)U=tonumber(U)local W="LibLocEffMal"local X={{1,20,A(W.."1")},{21,40,A(W.."2")},{41,60,A(W.."3")},{61,70,A(W.."4")},{71,80,A(W.."5")},{81,90,A(W.."6")},{91,100,A(W.."7")}}return string.format(v(U,X),V)end function B(U,V,W)local X=rpg.roll.dice(2,0,9)local Y=X[1]local Z=X[2]local ab="testVar :)"local bb=i(Y,Z)local cb=""local db=0 local eb=""local fb="LibEffCrit"local gb=1 if U=="Tête"then if bb >= 1 and bb <= 10 then cb="Blessure spectaculaire"db=1 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 11 and bb <= 20 then cb="Coupure mineure"db=1 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 21 and bb <= 25 then cb="Coup à l'oeil"db=1 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 26 and bb <= 30 then cb="Frappe à l'oreille"db=1 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 31 and bb <= 35 then cb="Coup percutant"db=2 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 36 and bb <= 40 then cb="Oeil au beurre noir"db=2 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 41 and bb <= 45 then cb="Oreille tranchée"db=2 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 46 and bb <= 50 then cb="En plein front"db=2 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 51 and bb <= 55 then cb="Mâchoire fracturée"db=3 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 56 and bb <= 60 then cb="Blessure majeure à l'oeil"db=3 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 61 and bb <= 65 then cb="Blessure majeure à l'oreille"db=3 gb= gb+1 eb=string.format(y(fb..gb),V,W,W,W)elseif bb >= 66 and bb <= 70 then cb="Nez cassé"db=3 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 71 and bb <= 75 then cb="Mâchoire cassée"db=4 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 76 and bb <= 80 then cb="Commotion cérébrale"db=4 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 81 and bb <= 85 then cb="Bouche explosée"db=4 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 86 and bb <= 90 then cb="Oreille mutilée"db=4 gb= gb+1 eb=string.format(y(fb..gb),W,V)elseif bb >= 91 and bb <= 93 then cb="Œil crevé"db=5 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 94 and bb <= 96 then cb="Coup défigurant"db=5 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 97 and bb <= 99 then cb="Mâchoire mutilée"db=5 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb==100 then cb="Mort"db=666 gb= gb+1 eb=string.format(y(fb..gb),V,W)end elseif U == "Bras secondaire"or U == "Bras principal"then if bb >= 1 and bb <= 10 then cb="Choc au bras"db=1 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 11 and bb <= 20 then cb="Coupure mineure"db=1 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 21 and bb <= 25 then cb="Torsion"db=1 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 26 and bb <= 30 then cb="Choc violent au bras"db=2 gb= gb+1 eb=string.format(y(fb..gb),W,U)elseif bb >= 31 and bb <= 35 then cb="Déchirure musculaire"db=2 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 36 and bb <= 40 then cb="Main ensanglantée"db=2 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 41 and bb <= 45 then cb="Clef de bras"db=2 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 46 and bb <= 50 then cb="Blessure béante"db=3 gb= gb+1 eb=string.format(y(fb..gb),W,U)elseif bb >= 51 and bb <= 55 then cb="Cassure nette"db=3 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 56 and bb <= 60 then cb="Ligament rompu"db=3 gb= gb+1 eb=string.format(y(fb..gb),W,U)elseif bb >= 61 and bb <= 65 then cb="Coupure profonde"db=3 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 66 and bb <= 70 then cb="Artère endommagée"db=4 gb= gb+1 eb=string.format(y(fb..gb),W,U)elseif bb >= 71 and bb <= 75 then cb="Coude fracassé"db=4 gb= gb+1 eb=string.format(y(fb..gb),U,W,W)elseif bb >= 76 and bb <= 80 then cb="Épaule luxée"db=4 gb= gb+1 eb=string.format(y(fb..gb),U,W,W)elseif bb >= 81 and bb <= 85 then cb="Doigt sectionné"db=4 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 86 and bb <= 90 then cb="Main ouverte"db=5 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 91 and bb <= 93 then cb="Biceps déchiqueté"db=5 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 94 and bb <= 96 then cb="Main mutilée"db=5 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb >= 97 and bb <= 99 then cb="Tendons coupés"db=5 gb= gb+1 eb=string.format(y(fb..gb),U,W)elseif bb==100 then cb="Démembrement fatal"db=666 gb= gb+1 eb=string.format(y(fb..gb),U,W)end elseif U=="Corps"then if bb >= 1 and bb <= 10 then cb="Rien qu'une égratignure !"db=1 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 11 and bb <= 20 then cb="Coup au ventre"db=1 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 21 and bb <= 25 then cb="Coup bas"db=1 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 26 and bb <= 30 then cb="Torsion du dos"db=1 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 31 and bb <= 35 then cb="Souffle coupé"db=2 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 36 and bb <= 40 then cb="Bleus aux côtes"db=2 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 41 and bb <= 45 then cb="Clavicule tordue"db=2 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 46 and bb <= 50 then cb="Chairs déchirées"db=2 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 51 and bb <= 55 then cb="Côtes fracturées"db=3 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 56 and bb <= 60 then cb="Blessure béante"db=3 gb= gb+1 eb=string.format(y(fb..gb),W,U)elseif bb >= 61 and bb <= 65 then cb="Entaille douloureuse"db=3 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 66 and bb <= 70 then cb="Dégâts artériels"db=3 gb= gb+1 eb=string.format(y(fb..gb),W,U)elseif bb >= 71 and bb <= 75 then cb="Dos froissé"db=4 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 76 and bb <= 80 then cb="Hanche fracturée"db=4 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 81 and bb <= 85 then cb="Blessure majeure au torse"db=4 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 86 and bb <= 90 then cb="Blessure au ventre"db=4 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 91 and bb <= 93 then cb="Cage thoracique perforée"db=5 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 94 and bb <= 96 then cb="Clavicule cassée"db=5 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 97 and bb <= 99 then cb="Hémorragie interne"db=5 gb= gb+1 eb=string.format(y(fb..gb))elseif bb==100 then cb="Éventré"db=666 gb= gb+1 eb=string.format(y(fb..gb),W)end elseif U == "Jambe gauche"or U == "Jambe droite"then if bb >= 1 and bb <= 10 then cb="Orteil contusionné"db=1 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 11 and bb <= 20 then cb="Cheville tordue"db=1 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 21 and bb <= 25 then cb="Coupure mineure"db=1 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 26 and bb <= 30 then cb="Perte d'équilibre"db=1 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 31 and bb <= 35 then cb="Coup à la cuisse"db=2 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 36 and bb <= 40 then cb="Cheville foulée"db=2 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 41 and bb <= 45 then cb="Genou tordu"db=2 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 46 and bb <= 50 then cb="Coupure à l'orteil"db=2 gb= gb+1 eb=string.format(y(fb..gb))elseif bb >= 51 and bb <= 55 then cb="Mauvaise coupure"db=3 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 56 and bb <= 60 then cb="Genou méchamment tordu"db=3 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 61 and bb <= 65 then cb="Jambe charcutée"db=3 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 66 and bb <= 70 then cb="Cuisse lacérée"db=3 gb= gb+1 eb=string.format(y(fb..gb),V,W,W,U)elseif bb >= 71 and bb <= 75 then cb="Tendon rompu"db=4 gb= gb+1 eb=string.format(y(fb..gb),W,W)elseif bb >= 76 and bb <= 80 then cb="Entaille au tibia"db=4 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 81 and bb <= 85 then cb="Genou cassé"db=4 gb= gb+1 eb=string.format(y(fb..gb),V,W,W)elseif bb >= 86 and bb <= 90 then cb="Genou démis"db=4 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 91 and bb <= 93 then cb="Pied écrasé"db=5 gb= gb+1 eb=string.format(y(fb..gb),V,W)elseif bb >= 94 and bb <= 96 then cb="Pied sectionné"db=5 gb= gb+1 eb=string.format(y(fb..gb),W)elseif bb >= 97 and bb <= 99 then cb="Tendon coupé"db=5 gb= gb+1 eb=string.format(y(fb..gb),W,W)elseif bb==100 then cb="Bassin fracassé"db=666 gb= gb+1 eb=string.format(y(fb..gb),V,W,W)end end return Y,Z,cb,db,eb end function C(U,V)if V[U]then return V[U]else return false end end function D(U)local V={}local W=string.match(U,".*(Enroulement).*")V["enroulement"]= W~=nil local X=string.match(U,".*(Poudre).*")V["poudre"]= X~=nil local Y=string.match(U,".*Répétition%((%d*)%).*")V["repetition"]=Y local Z=string.match(U,".*(Assommante).*")V["assommante"]= Z~=nil local ab=string.match(U,".*(Défensive).*")V["defensive"]= ab~=nil local bb=string.match(U,".*(Devastatrice).*")V["devastatrice"]= bb~=nil local cb=string.match(U,".*(Empaleuse).*")V["empaleuse"]= cb~=nil local db=string.match(U,".*Explosion%((%d*)%).*")V["explosion"]=db local eb=string.match(U,".*(Immobilisante).*")V["immobilisante"]= eb~=nil local fb=string.match(U,".*(Incassable).*")V["incassable"]= fb~=nil local gb=string.match(U,".*(Percutante).*")V["percutante"]= gb~=nil local hb=string.match(U,".*(Perforante).*")V["perforante"]= hb~=nil local ib=string.match(U,".*(Perturbante).*")V["perturbante"]= ib~=nil local jb=string.match(U,".*(Piège-lame).*")V["piegeLame"]= jb~=nil local kb=string.match(U,".*(Pistolet).*")V["pistolet"]= kb~=nil local lb=string.match(U,".*(Pointue).*")V["pointue"]= lb~=nil local mb=string.match(U,".*(Précise).*")V["precise"]= mb~=nil local nb=string.match(U,".*Protectrice%((%d*)%).*")V["protectrice"]= nb~=nil local ob=string.match(U,".*(Rapide).*")V["rapide"]= ob~=nil local pb=string.match(U,".*(Taille).*")V["taille"]= pb~=nil local qb=string.match(U,".*(Dangereuse).*")V["dangereuse"]= qb~=nil local rb=string.match(U,".*(Épuisante).*")V["epuisante"]= rb~=nil local sb=string.match(U,".*(Imprécise).*")V["imprecise"]= sb~=nil local tb=string.match(U,".*(Inoffensive).*")V["inoffensive"]= tb~=nil local ub=string.match(U,".*(Inoffensive).*")V["imprecise"]= ub~=nil local vb=string.match(U,".*(Lente).*")V["lente"]= vb~=nil local wb=string.match(U,".*Recharge%((%d*)%).*")V["recharge"]= wb~=nil return V end function E(U)local V,W={},{}for X=2,11,1 do local Y=rpg.character.getfield(U,string.format("b43_l%d_f1i",X))if(rpg.character.getfield(U, string.format("b43_l%d_f7c", X)) ~= ""and true)then V["Nom"]=rpg.character.getfield(U,string.format("b43_l%d_f1i",X))V["Groupe"]=rpg.character.getfield(U,string.format("b43_l%d_f2i",X))V["Encombrement"]=rpg.character.getfield(U,string.format("b43_l%d_f3i",X))V["PorteeAllonge"]=rpg.character.getfield(U,string.format("b43_l%d_f4i",X))V["Degats"]=rpg.character.getfield(U,string.format("b43_l%d_f5i",X))V["AtoutsDefauts"]=rpg.character.getfield(U,string.format("b43_l%d_f6i",X))end end for X=2,11,1 do local Y=rpg.character.getfield(U,string.format("b43_l%d_f1i",X))if(rpg.character.getfield(U, string.format("b43_l%d_f8c", X)) ~= ""and true)then W["Nom"]=rpg.character.getfield(U,string.format("b43_l%d_f1i",X))W["Groupe"]=rpg.character.getfield(U,string.format("b43_l%d_f2i",X))W["Encombrement"]=rpg.character.getfield(U,string.format("b43_l%d_f3i",X))W["PorteeAllonge"]=rpg.character.getfield(U,string.format("b43_l%d_f4i",X))W["Degats"]=rpg.character.getfield(U,string.format("b43_l%d_f5i",X))W["AtoutsDefauts"]=rpg.character.getfield(U,string.format("b43_l%d_f6i",X))end end print("armeEnMain, deuxiemeArme:",V,W)return V,W end function G(U)local V=0 for W=1,10,1 do if(rpg.character.getfield(U, string.format("b46_l1_f%dc", W)) == "on"and true)then V=W end end return V end function H(U)local V= tonumber(rpg.character.getfield(U, "b40_l1_f1i"))or 0 if(V>0)then return V else return 0 end end function I(U)local V= tonumber(rpg.character.getfield(U, "b40_l2_f1i"))or 0 if(V>0)then return V else return 0 end end function J(U,V,W,X,Y,Z,ab,bb,cb)print("EvaluateTest",U,W,X,Y,Z,ab,bb,cb)U=string.lower(U)local db=""local eb="EvaTst"if U=="simple"then if Y and Z then local fb=T("div",nil,nil,nil,"display: flex; color: white")local gb=fb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; width: 100%")gb.addChild("span",string.format("Résultat du Test %s",U),nil,nil,"font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px")local hb=gb.addChild("div",nil,nil,nil,"display: flex; width: 100%")local ib=hb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; flex-grow: 1; align-items: center")ib.addChild("div",V,nil,nil,"display: flex; font-weight: bold")ib.addChild("div", W.." (" .. X .. ")",nil,nil,"display: flex")ib.addChild("div", "Difficulté "..o(Z) .. " (" .. p(Z) .. ")",nil,nil,"display: flex")ib.addChild("div", "Seuil effectif : "..Y,nil,nil,"display: flex")local jb=fb.build()local kb=T("div",nil,nil,nil,"display: flex; color: white")local lb=kb.addChild("div",nil,nil,nil,"display: flex; flex-direction: row; width: 100%")local mb=lb.addChild("div",nil,nil,nil,"display: flex; width: 100%; justify-content: center")mb.addChild("div",bb,nil,"yellow_d10",y("EvaTst2"))mb.addChild("div",cb,nil,"white_d10",y("EvaTst2"))local nb=kb.build()local ob=i(bb,cb)local pb=j(ob,Y)local qb=l(U,bb,cb)local rb=""if pb==true then rb="Succès"else rb="Échec"end local sb=""if qb==true then sb="Critique"else sb=""end local tb=string.format(y(eb..3),ob,Y,rb,sb)local ub=""if pb and not qb then ub=string.format(y(eb..4))elseif pb and qb then ub=string.format(y(eb..5))elseif not pb and not qb then ub=string.format(y(eb..6))elseif not pb and qb then ub=string.format(y(eb..7))end return rpg.smf.save(jb,nb,tb,ub,"wfrp4")end elseif U=="spectaculaire"then local fb=T("div",nil,nil,nil,"display: flex; color: white")local gb=fb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; width: 100%")gb.addChild("span",string.format("Résultat du Test %s",U),nil,nil,"font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px")local hb=gb.addChild("div",nil,nil,nil,"display: flex; width: 100%")local ib=hb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; flex-grow: 1; align-items: center")ib.addChild("div",V,nil,nil,"display: flex; font-weight: bold")ib.addChild("div", W.." (" .. X .. ")",nil,nil,"display: flex")ib.addChild("div", "Difficulté "..o(Z) .. " (" .. p(Z) .. ")",nil,nil,"display: flex")ib.addChild("div", "Seuil effectif : "..Y,nil,nil,"display: flex")local jb=fb.build()local kb=T("div",nil,nil,nil,"display: flex; color: white")local lb=kb.addChild("div",nil,nil,nil,"display: flex; flex-direction: row; width: 100%")local mb=lb.addChild("div",nil,nil,nil,"display: flex; width: 100%; justify-content: center")mb.addChild("div",bb,nil,"yellow_d10",y("EvaTst2"))mb.addChild("div",cb,nil,"white_d10",y("EvaTst2"))local nb=kb.build()local ob=i(bb,cb)local pb=j(ob,Y)local qb=l(U,bb,cb)local rb=s(ob,Y)local sb=""local tb=""local ub=""if pb==true then if qb then db=string.format(y(eb..9),ob,Y,rb)ub=string.format(y(eb..10))else if(rb >= 6 and true)then db=string.format(y(eb..11),ob,Y,rb)ub=string.format(y(eb..12))elseif(rb == 4 or rb == 5)then db=string.format(y(eb..13),ob,Y,rb)ub=string.format(y(eb..14))elseif rb == 2 or rb == 3 then db=string.format(y(eb..15),ob,Y,rb)ub=string.format(y(eb..16))elseif rb == 0 or rb == 1 then db=string.format(y(eb..17),ob,Y,rb)ub=string.format(y(eb..18))end end elseif pb==false then if qb then db=string.format(y(eb..19),ob,Y,rb)ub=string.format(y(eb..20))else if rb<=-6 then db=string.format(y(eb..21),ob,Y,rb)ub=string.format(y(eb..22))elseif rb == -4 or rb == -5 then db=string.format(y(eb..23),ob,Y,rb)ub=string.format(y(eb..24))elseif rb == -2 or rb == -3 then db=string.format(y(eb..25),ob,Y,rb)ub=string.format(y(eb..26))elseif rb == 0 or rb == -1 then db=string.format(y(eb..27),ob,Y,rb)ub=string.format(y(eb..28))end end end local vb=db local wb=ub return rpg.smf.save(jb,nb,vb,wb,"wfrp4")else return rpg.smf.save("Type de test inconnu","myrolls","myresults","myfooter","wfrp4")end end function K(U,V,W,X,Y,Z,ab,bb,cb,db,eb,fb,gb,hb)local ib=""local jb= U or"Protagoniste 1"local kb= bb or"Protagoniste 2"local lb=T("div",nil,nil,nil,"display: flex; color: white")local mb=lb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; width: 100%")mb.addChild("span","Résultat du Test Opposé",nil,nil,"font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px")local nb=mb.addChild("div",nil,nil,nil,"display: flex; width: 100%")local ob=nb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; flex-grow: 1; align-items: center")ob.addChild("div",jb,nil,nil,"display: flex; font-weight: bold")ob.addChild("div", V.." (" .. W .. ")",nil,nil,"display: flex")ob.addChild("div", "Difficulté "..o(Y) .. " (" .. p(Y) .. ")",nil,nil,"display: flex")ob.addChild("div", "Seuil effectif : "..X,nil,nil,"display: flex")nb.addChild("hr",nil,nil,nil,"border: color; margin: 5px; width: 2px")local pb=nb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; flex-grow: 1; align-items: center")pb.addChild("div",kb,nil,nil,"display: flex; font-weight: bold")pb.addChild("div", cb.." (" .. db .. ")",nil,nil,"display: flex")pb.addChild("div", "Difficulté "..o(fb) .. " (" .. p(fb) .. ")",nil,nil,"display: flex")pb.addChild("div", "Seuil effectif : "..eb,nil,nil,"display: flex")local qb=lb.build()local rb=T("div",nil,nil,nil,"display: flex; color: white")local sb=rb.addChild("div",nil,nil,nil,"display: flex; flex-direction: row; width: 100%")local tb=sb.addChild("div",nil,nil,nil,"display: flex; width: 100%; justify-content: center")tb.addChild("div",Z,nil,"yellow_d10",y("EvaTst2"))tb.addChild("div",ab,nil,"white_d10",y("EvaTst2"))sb.addChild("hr",nil,nil,nil,"border: color; margin: 5px; width: 2px;")local ub=sb.addChild("div",nil,nil,nil,"display: flex; width: 100%; justify-content: center")ub.addChild("div",gb,nil,"yellow_d10",y("EvaTst2"))ub.addChild("div",hb,nil,"white_d10",y("EvaTst2"))local vb=rb.build()local wb=i(Z,ab)local xb=i(gb,hb)local yb=j(wb,X)local zb=j(xb,eb)local Ab=l("oppose",Z,ab)local Bb=l("oppose",gb,hb)local Cb=s(wb,X)local Db=s(xb,eb)local Eb=""local Fb=""local Gb=""local Hb=""local Ib=""local Jb=""local Kb=""local Lb=""if Ab then Ib="Critique"if(Cb >= 0 and Cb < 6)then Cb=6 elseif(Cb <= 0 and Cb > -6)then Cb=-6 end end if Bb then Jb="Critique"if(Db >= 0 and Db < 6)then Db=6 elseif(Db <= 0 and Db > -6)then Db=-6 end end Cb= Cb+t(W)Db= Db+t(db)if yb then Eb="Succès"else Eb="Échec"end if zb then Fb="Succès"else Fb="Échec"end Gb=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",Eb,Ib,Cb)Hb=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",Fb,Jb,Db)local Mb=T("div",nil,nil,nil,"display: flex; color: white")local Nb=Mb.addChild("div",nil,nil,nil,"display: flex; flex-direction: row; width: 100%")local Ob=Nb.addChild("div",nil,nil,nil,"display: flex; width: 100%; justify-content: center")Ob.addChild("span",Gb,nil,nil,"color: white")Nb.addChild("hr",nil,nil,nil,"border: color; margin: 5px; width: 2px;")local Pb=Nb.addChild("div",nil,nil,nil,"display: flex; width: 100%; justify-content: center")Pb.addChild("span",Hb,nil,nil,"color: white")local Qb=Mb.build()local Rb=""local Sb=""local Tb=""if(Cb > Db and true)then Tb=string.format("[u]%s remporte le Test[/u][br/]avec %d Degrés de Réussite d'écart.",jb, Cb-Db)Rb=jb Sb=kb elseif(Cb < Db and true)then Tb=string.format("[u]%s remporte le Test[/u][br/]avec %d Degrés de Réussite d'écart.",kb, Db-Cb)Rb=kb Sb=jb elseif(Cb == Db and true)then if yb and not zb then Tb=string.format("[u]%s remporte le Test[/u], départagé par le Succès du lancer",jb)Rb=jb Sb=kb elseif zb and not yb then Tb=string.format("[u]%s remporte le Test[/u], départagé par le Succès du lancer.",kb)Rb=kb Sb=jb elseif(yb and yb)or(not yb and not zb)then if X>eb then Tb=string.format("[u]%s remporte le Test de peu[/u], départagé par le Seuil du Test.",jb)Rb=jb Sb=kb elseif(X < eb and true)then Tb=string.format("[u]%s remporte le Test[/u], départagé par le Seuil du Test.",kb)Rb=kb Sb=jb elseif(X == eb and true)then if W>db then Tb=string.format("[u]%s remporte le Test[/u], départagé par le Score de compétence.",jb)Rb=jb Sb=kb elseif(W < db and true)then Tb=string.format("[u]%s remporte le Test[/u], départagé par le Score de compétence.",kb)Rb=kb Sb=jb elseif(W == db and true)then if(wb < xb and true)then Tb=string.format("[u]%s remporte le Test[/u], départagé par le Lancer de dé.",jb)Rb=jb Sb=kb elseif(wb > wb and true)then Tb=string.format("[u]%s remporte le Test[/u], départagé par le Lancer de dé.",kb)Rb=kb Sb=jb elseif(wb == xb and true)then Tb=string.format("[u]Aucun protagoniste ne remporte le Test, c'est une égalité parfaite[/u].")end end end end end local Ub=""if yb and zb then Ub= Ub..string.format( "Les deux protagonistes ont réussi, mais %s a tout de même pris le dessus sur %s.", Rb, Sb )elseif(yb and not zb)or(zb and not yb)then Ub= Ub..string.format("Le résultat est clair, sans ambigüité : %s a réussi et %s a échoué.", Rb, Sb)elseif not yb and not zb then Ub= Ub.."Toutefois, les deux protagonistes ont échoué, quel duel de bras cassés !"end local Vb=""Vb= Vb..'[hr style="border: color; margin: 5px; "]'Vb= Vb..'[div style="display: flex;margin-top: 10px"]'Vb= Vb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'Vb= Vb..'[div style="color: white"]'Vb= Vb..'[div style="color: white; font-size: 1.2em; font-weight: bold; padding-bottom:5px; line-height: 1.4em"]' .. Tb .. "[/div]"Vb= Vb..'[div style="color: white; font-weight: bold; padding-top:5px"]' .. Ub .. "[/div]"Vb= Vb.."[/div]"Vb= Vb.."[/div]"Vb= Vb.."[/div]"return rpg.smf.save(qb,vb,Qb,Vb,"wfrp4")end function L(U)if _VERSION=="Lua 5.1"then return unpack(U)elseif _VERSION == "Lua 5.2" or _VERSION == "Lua 5.3"or _VERSION == "Lua 5.4"then return table.unpack(U)end end function M(U)print("EvaluateTestCorpsACorps")local V,W,X,Y,Z,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb=L(U)local nb=""local ob= V or"Protagoniste 1"local pb= eb or"Protagoniste 2"local qb=""nb= nb..'[div style="display: flex; color: white"]'nb= nb..'[div style="display: flex; flex-direction: column; width: 100%"]'nb= nb..'[span style="font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px"]'nb= nb.."Attaque au Corps-à-Corps"nb= nb.."[/span]"nb= nb..'[div style="display: flex; width: 100%"]'nb= nb..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'nb= nb..'[div style="display: flex; font-weight: bold"]'nb= nb.."Attaquant"nb= nb.."[/div]"nb= nb..'[div style="display: flex; font-weight: bold"]'nb= nb..ob nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Seuil de base : " .. W nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Difficulté " .. o(Y) .. " (" .. p(Y) .. ")"nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb..Z .. " Avantages (" .. q(Z) .. ")"nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Seuil effectif : " .. X nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Bonus de Force : " .. cb nb= nb.."[/div]"if#db>0 then nb= nb..'[div style="display: flex"]'nb= nb.."[span]Atouts d'Arme : [/span]"for cc,dc in pairs(db)do if(dc)then nb= nb.."[span]" .. dc .. "[/span]"end end nb= nb.."[/div]"end nb= nb.."[/div]"nb= nb..'[hr style="border: color; margin: 5px"]'nb= nb..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'nb= nb..'[div style="display: flex; font-weight: bold"]'nb= nb.."Défenseur"nb= nb.."[/div]"nb= nb..'[div style="display: flex; font-weight: bold"]'nb= nb..pb nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Seuil de base : " .. fb nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Niveau " .. o(hb) .. " (" .. p(hb) .. ")"nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb..ib .. " Avantages (" .. q(ib) .. ")"nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Seuil effectif : " .. gb nb= nb.."[/div]"nb= nb..'[div style="display: flex"]'nb= nb.."Bonus d'Endurance : " .. lb nb= nb.."[/div]"nb= nb.."[/div]"nb= nb.."[/div]"nb= nb.."[/div]"nb= nb.."[/div]"local rb=""rb= rb..'[div style="display: flex"]'rb= rb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'rb= rb..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'rb= rb..ab rb= rb.."[/div]"rb= rb..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'rb= rb..bb rb= rb.."[/div]"rb= rb.."[/div]"rb= rb..'[hr style="border: color; margin: 5px"]'rb= rb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'rb= rb..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'rb= rb..jb rb= rb.."[/div]"rb= rb..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'rb= rb..kb rb= rb.."[/div]"rb= rb.."[/div]"rb= rb.."[/div]"local sb=i(ab,bb)local tb=i(jb,kb)local ub=j(sb,X)local vb=j(tb,gb)local wb=l("corps-a-corps",ab,bb)local xb=l("corps-a-corps",jb,kb)local yb=s(sb,X)local zb=s(tb,gb)local Ab=""local Bb=""local Cb=""local Db=""local Eb=""local Fb=""local Gb=""local Hb=""local Ib=""if wb then Cb="Critique"end if xb then Db="Critique"end yb= yb+t(W)zb= zb+t(fb)if ub then Ab="Succès"else Ab="Échec"end if vb then Bb="Succès"else Bb="Échec"end Eb=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",Ab,Cb,yb)Fb=string.format("%s %s[br/]avec [u]%d Degrés de Réussite[/u]",Bb,Db,zb)local Jb=""Jb= Jb..'[div style="display: flex"]'Jb= Jb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'Jb= Jb..'[span class="" style="color: white"]'Jb= Jb..Eb Jb= Jb.."[/span]"Jb= Jb.."[/div]"Jb= Jb..'[hr style="border: color; margin: 5px"]'Jb= Jb..'[div style="display: flex; flex-grow: 1; justify-content: center"]'Jb= Jb..'[span class="" style="color: white"]'Jb= Jb..Fb Jb= Jb.."[/span]"Jb= Jb.."[/div]"Jb= Jb.."[/div]"local Kb=""local Lb=""local Mb=""local Nb=""local Ob=""local Pb=""local Qb=0 local Rb=0 local Sb=""local Tb=""local Ub=0 local Vb=0 local Wb=0 local Xb=0 if wb then Mb=w(rpg.roll.dice(1,1,100)[1])Ub,Vb,Ob,Qb,Sb=B(Mb,ob,pb)else Mb=w(sb)Ob=x(Mb)end if xb then Nb=w(rpg.roll.dice(1,1,100)[1])Wb,Xb,Pb,Rb,Tb=B(Nb,pb,ob)end if(ub and wb)then Hb= Hb..string.format( "[u]%s porte un Coup Critique[/u] touchant %s avec pour effet [b]%s[/b]. Le coup fait perdre directement %d Points de Blessure, avec des effets supplémentaires : %s", ob, pb, Ob, Qb, Sb )end if(vb and xb)then Ib= Ib..string.format( "[u]En se défendant de l'attaque de %s, %s réussit un Coup Critique[/u] avec pour effet [b]%s[/b]. Le coup outrepasse l'armure éventuelle, et occasionne directement %d Dégâts, avec les effets supplémentaires suivants : %s", ob, pb, Pb, Rb, Tb )end Gb= Hb.."[br/]" .. Ib .. "[br/]"local Yb,Zb=u(yb,cb,zb,lb,"+BF +3",db)if(yb > zb and true)then Gb= Gb..string.format( "[u]%s attaque avec succès[/u]. Il touche %s %s et occasionne des Dégâts à hauteur de " ..  Zb .. " = %d Points de Blessure", ob, pb, Nb, Yb )Kb=ob Lb=pb elseif(yb < zb and true)then Gb= Gb..string.format( "[u]%s remporte le Test[/u][br/]avec %d Degrés de Réussite d'écart.", pb, zb - yb )Kb=pb Lb=ob elseif(yb == zb and true)then if ub and not vb then Gb= Gb..string.format(  "[u]%s remporte le Test[/u], départagé par le Succès du lancer. Il touche %s %s et occasionne des Dégâts à hauteur de " ..  Zb .. " = %d Points de Blessure",  ob,  pb,  Nb,  Yb )Kb=ob Lb=pb elseif vb and not ub then Gb= Gb..string.format("[u]%s remporte le Test[/u], départagé par le Succès du lancer.", pb)Kb=pb Lb=ob elseif(ub and ub)or(not ub and not vb)then if(X > gb and true)then Gb=  Gb..string.format(  "[u]%s remporte le Test de peu[/u], départagé par le Seuil du Test. Il touche %s %s et occasionne des Dégâts à hauteur de " ..  Zb .. " = %d Points de Blessure",  ob,  pb,  Nb,  Yb  )Kb=ob Lb=pb elseif(X < gb and true)then Gb=  Gb..string.format("[u]%s remporte le Test[/u], départagé par le Seuil du Test.", pb)Kb=pb Lb=ob elseif(X == gb and true)then if W>fb then Gb=  Gb..string.format(  "[u]%s remporte le Test[/u], départagé par le Score de compétence. Il touche %s %s et occasionne des Dégâts à hauteur de " ..  Zb .. " = %d Points de Blessure",  ob,  pb,  Nb,  Yb  )Kb=ob Lb=pb elseif(W < fb and true)then Gb=  Gb..string.format(  "[u]%s remporte le Test[/u], départagé par le Score de compétence.",  pb  )Kb=pb Lb=ob elseif(W == fb and true)then if(sb < tb and true)then Gb=  Gb..string.format(  "[u]%s remporte le Test[/u], départagé par le Lancer de dé. Il touche %s %s et occasionne des Dégâts à hauteur de " ..   Zb .. " = %d Points de Blessure",  ob,  pb,  Nb,  Yb  )Kb=ob Lb=pb elseif(sb > tb and true)then Gb=  Gb..string.format(  "[u]%s remporte le Test[/u], départagé par le Lancer de dé.",  pb  )Kb=pb Lb=ob elseif(sb == tb and true)then Gb=  Gb..string.format("[u]Aucun protagoniste ne remporte le Test, c'est une égalité parfaite[/u].")end end end end end local ac=""if ub and vb then ac= ac..string.format( "Les deux protagonistes ont réussi, mais %s a tout de même pris le dessus sur %s.", Kb, Lb )elseif(ub and not vb)then ac= ac..string.format("Le résultat est clair, sans ambigüité : %s a réussi et %s a échoué.", Kb, Lb)elseif(vb and not ub)then ac= ac..string.format("Le résultat est clair, sans ambigüité : %s a réussi et %s a échoué.", Kb, Lb)elseif not ub and not vb then ac= ac.."Toutefois, les deux protagonistes ont échoué, quel duel de bras cassés !"end local bc=""bc= bc..'[hr style="border: color; margin: 5px; "]' .. '[div style="display: flex;margin-top: 10px"]' .. '[div style="display: flex; flex-grow: 1; justify-content: center"]' ..  '[div style="color: white"]' ..  '[div style="color: white; font-size: 1.2em; font-weight: bold; padding-bottom:5px; line-height: 1.4em"]' ..  Gb ..  "[/div]" ..   '[div style="color: white; font-weight: bold; padding-top:5px"]' ..   ac .. "[/div]" .. "[/div]" .. "[/div]" .. "[/div]"return rpg.smf.save(nb,rb,Jb,bc,"wfrp4")end function N(U,V)local W={}W["Player"]="Player"W["Name"]="Name"W["Nom"]="b2_l1_f1i"W["Art"]="b12_l2_f5i"W["Athlétisme"]="b12_l3_f5i"W["Calme"]="b12_l4_f5i"W["Charme"]="b12_l5_f5i"W["Chevaucher"]="b12_l6_f5i"W["Corps à corps (base)"]="b12_l7_f5i"W["Corps à corps"]="b12_l8_f5i"W["Commandement"]="b12_l9_f5i"W["Conduite d'attelage"]="b12_l10_f5i"W["Discrétion"]="b12_l11_f5i"W["Divertissement"]="b12_l12_f5i"W["Emprise sur les animaux"]="b12_l13_f5i"W["Escalade"]="b12_l14_f5i"W["Esquive"]="b13_l2_f5i"W["Intimidation"]="b13_l3_f5i"W["Intuition"]="b13_l4_f5i"W["Marchandage"]="b13_l5_f5i"W["Orientation"]="b13_l6_f5i"W["Pari"]="b13_l7_f5i"W["Perception"]="b13_l8_f5i"W["Ragot"]="b13_l9_f5i"W["Ramer"]="b13_l10_f5i"W["Résistance"]="b13_l11_f5i"W["Résistance à l'alcool"]="b13_l12_f5i"W["Subornation"]="b13_l13_f5i"W["Survie en extérieur"]="b13_l14_f5i"for Y=2,14,1 do if(rpg.character.getfield(V, string.format("b14_l%d_f1i", Y)) ~= "" and rpg.character.getfield(V, string.format("b14_l%d_f1i", Y)) ~= nil and true)then W[rpg.character.getfield(V,string.format("b14_l%d_f1i",Y))]=string.format("b14_l%d_f5i",Y)end end local X=W[U]return X end function O(U)local V={}V["idPersonnage"]=string.match(U,".*ID%((%d-)%).*")V["competence"]=string.match(U,".*Competence%((.-)%)%s.*")V["difficulte"]=string.match(U,".*Difficulté%((.-)%).*")return V end function rpg.accel.ask(U)print("ask",U,_VERSION)return P(U,"ask")end function rpg.accel.test(U)print("test",U,_VERSION)return P(U,"run")end function Q(U,V)print(U,V)end function y(U)U=tostring(U)for V=2,500,1 do local W=rpg.character.getfield(g,string.format("b1_l%d_f1i",V))local X=rpg.character.getfield(g,string.format("b1_l%d_f2i",V))if(W ~= "" and W ~= nil and U == W)then return X end end return""end function A(U)local V for W=2,31,1 do local X=rpg.character.getfield(g,string.format("b2_l%d_f1i",W))local Y=rpg.character.getfield(g,string.format("b2_l%d_f2t",W))if(X ~= "" and X ~= nil and U == X)then if _VERSION=="Lua 5.1"then V,R=loadstring(Y)elseif _VERSION == "Lua 5.2" or _VERSION == "Lua 5.3"or _VERSION == "Lua 5.4"then V,R=load(Y)end if V then return V else print("Compilation error:",R)end return Y end end return false end function P(U,V)print("launch",U,V)local W=U local X local Y={["simple"]="Simple",["spectaculaire"]="Spectaculaire",["oppose"]="Opposé",["corps-a-corps"]="Corps à Corps",["distance"]="Combat à distance"}local Z=""local ab,bb=string.match(U,"^([%w%p]*)[%s*](.*)$")if ab == "simple"or ab == "spectaculaire"then bb=string.match(bb,"^.*(ID.*)%s*/?.*$")elseif ab == "oppose" or ab == "corps-a-corps"or ab == "distance"then bb,X=string.match(bb,"^(.*)%s*/%s*(.*)$")end local cb,db,eb,fb local gb="wfrp4"local hb=Y[ab]local ib={}table.insert(ib,O(bb))local jb=ib[1]["idPersonnage"]local kb=ib[1]["competence"]local lb=tonumber(rpg.character.getfield(jb,N(kb,jb)))local mb=ib[1]["difficulte"]local nb=o(mb)local ob=m(n(mb))local pb=rpg.character.getfield(jb,N("Nom",jb))local qb= lb+ob local rb=rpg.character.getfield(jb,N("Player",jb))if ab == "simple"or ab == "spectaculaire"then if V=="ask"then local tb=T("div",nil,nil,nil,"display: flex; color: white")local ub=tb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; width: 100%")ub.addChild("span",string.format("[b]%s doit réaliser un Test %s[/b]",rb,hb),nil,nil,"font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px")local vb=ub.addChild("div",nil,nil,nil,"display: flex; width: 100%")local wb=vb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; flex-grow: 1; align-items: center")wb.addChild("div",pb,nil,nil,"display: flex; font-weight: bold")wb.addChild("div", kb.." (" .. lb .. ")",nil,nil,"display: flex")wb.addChild("div", "Difficulté "..o(mb) .. " (" .. p(mb) .. ")",nil,nil,"display: flex")wb.addChild("div", "Seuil effectif : "..qb,nil,nil,"display: flex; font-weight: bold")cb=tb.build()local xb=T(nil,string.format(":test %s:",W),nil,nil,nil)db=""fb=xb.build()elseif V=="run"then local tb,ub=rpg.roll.dice(1,0,9)[1],rpg.roll.dice(1,0,9)[1]return J(ab,pb,kb,lb,qb,mb,ob,tb,ub)end elseif ab == "oppose" or ab == "corps-a-corps"or ab == "distance"then table.insert(ib,O(X))local tb=ib[2]["idPersonnage"]local ub=ib[2]["competence"]local vb=tonumber(rpg.character.getfield(tb,N(ub,tb)))local wb=ib[2]["difficulte"]local xb=o(wb)local yb=m(n(wb))local zb=rpg.character.getfield(tb,N("Nom",tb))local Ab= vb+yb local Bb=rpg.character.getfield(tb,N("Player",tb))if V=="ask"then if ab == "oppose"or ab == "corps-a-corps"then local Cb=T("div",nil,nil,nil,"display: flex; color: white")local Db=Cb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; width: 100%")Db.addChild("span",string.format("[b]Votre Vénéré MJ demande un Test de %s[/b]",hb),nil,nil,"font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px")local Eb=Db.addChild("div",nil,nil,nil,"display: flex; width: 100%")local Fb=Eb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; flex-grow: 1; align-items: center")Fb.addChild("div",pb,nil,nil,"display: flex; font-weight: bold")Fb.addChild("div", kb.." (" .. lb .. ")",nil,nil,"display: flex")Fb.addChild("div",  "Difficulté "..o(mb) ..  " (" .. p(mb) .. ")",nil,nil,"display: flex")Fb.addChild("div", "Seuil effectif : "..qb,nil,nil,"display: flex")Eb.addChild("hr",nil,nil,nil,"border: color; margin: 5px; width: 2px")local Gb=Eb.addChild("div",nil,nil,nil,"display: flex; flex-direction: column; flex-grow: 1; align-items: center")Gb.addChild("div",zb,nil,nil,"display: flex; font-weight: bold")Gb.addChild("div", ub.." (" .. vb .. ")",nil,nil,"display: flex")Gb.addChild("div",  "Difficulté "..o(wb) ..  " (" .. p(wb) .. ")",nil,nil,"display: flex")Gb.addChild("div", "Seuil effectif : "..Ab,nil,nil,"display: flex")cb=Cb.build()local Hb=T(nil,string.format(":test %s:",W),nil,nil,nil)db=""fb=Hb.build()print("myheader, myrolls, myresults, myfooter ask oppose ou CC",cb,db,eb,fb)elseif ab=="distance"then print("ask distance")end elseif V=="run"then print("run",V,ab)local Cb,Db,Eb,Fb=rpg.roll.dice(1,0,9)[1],rpg.roll.dice(1,0,9)[1],rpg.roll.dice(1,0,9)[1],rpg.roll.dice(1,0,9)[1]print(Cb,Db,Eb,Fb)if ab=="oppose"then return K(pb,kb,lb,qb,mb,Cb,Eb,zb,ub,vb,Ab,wb,Db,Fb)elseif ab=="corps-a-corps"then print("repere run CC")print(V,ab)end end else return end local sb="[br/]Commande à copier dans un message :"return rpg.smf.save(cb,db,sb,fb,gb)end