function IsDouble(d1,d2)if(d1 == d2 and true)then return true else return false end end function GetD100(d1,d2)if d1 == 0 and d2 == 0 then return 100 else return d1 * 10+d2 end end OptionAutomatiqueDonneCritique=true SuccesAutomatiqueMax=1 EchecAutomatiqueMin=97 OptionDoubleDonneCritique=true OptionDRSupplementairePourSeuilsSuperieursA100=true function IsSuccess(d100,seuil)if(d100 <= seuil or (OptionAutomatiqueDonneCritique and d100 <= SuccesAutomatiqueMax))and not (OptionAutomatiqueDonneCritique and d100 >= EchecAutomatiqueMin)then return true else return false end end function IsFailure(d100,seuil)if d100 >= seuil or d100 >= EchecAutomatiqueMin then return true else return false end end function IsCritical(typetest,d1,d2)if(OptionDoubleDonneCritique and IsDouble(d1, d2))or((typetest ~= "corps-a-corps" or typetest ~= "distance") and OptionAutomatiqueDonneCritique and (GetD100(d1, d2) <= SuccesAutomatiqueMax or GetD100(d1, d2) >= EchecAutomatiqueMin))then return true else return false end end function GetModificateurDifficulte(difficulte)difficulte= tostring(difficulte)or"I"if difficulte=="TF"then return 60 elseif difficulte=="F"then return 40 elseif difficulte=="A"then return 20 elseif difficulte=="I"then return 0 elseif difficulte=="C"then return-10 elseif difficulte=="D"then return-20 elseif difficulte=="TD"then return-30 end end function GetCodeDifficulte(difficulte)difficulte=string.lower(difficulte)if difficulte == "tf"or difficulte == "tresfacile"then return"TF"elseif difficulte == "f"or difficulte == "facile"then return"F"elseif difficulte == "a"or difficulte == "accessible"then return"A"elseif difficulte == "i" or difficulte == "intermediaire"or difficulte == "interm√©diaire"then return"I"elseif difficulte == "c"or difficulte == "complexe"then return"C"elseif difficulte == "d"or difficulte == "difficile"then return"D"elseif difficulte == "td"or difficulte == "tresdifficile"then return"TD"end end function GetLibelleDifficulte(difficulte)difficulte=string.lower(difficulte)if difficulte == "tf"or difficulte == "tresfacile"then return"Tr√®s Facile"elseif difficulte == "f"or difficulte == "facile"then return"Facile"elseif difficulte == "a"or difficulte == "accessible"then return"Accessible"elseif difficulte == "i" or difficulte == "intermediaire"or difficulte == "interm√©diaire"then return"Interm√©diaire"elseif difficulte == "c"or difficulte == "complexe"then return"Complexe"elseif difficulte == "d"or difficulte == "difficile"then return"Difficile"elseif difficulte == "td"or difficulte == "tresdifficile"then return"Tr√®s Difficile"end end function GetLibelleModificateurDifficulte(difficulte)difficulte=string.lower(difficulte)if difficulte == "tf"or difficulte == "tresfacile"then return"+60"elseif difficulte == "f"or difficulte == "facile"then return"+40"elseif difficulte == "a"or difficulte == "accessible"then return"+20"elseif difficulte == "i" or difficulte == "intermediaire"or difficulte == "interm√©diaire"then return"0"elseif difficulte == "c"or difficulte == "complexe"then return"-10"elseif difficulte == "d"or difficulte == "difficile"then return"-20"elseif difficulte == "td"or difficulte == "tresdifficile"then return"-30"end end function GetLibelleModificateurAvantage(avantage)avantage=tonumber(avantage)if avantage<=0 then return"+0"elseif avantage>0 then return"+"..avantage * 10 end end function GetSeuilEffectif(seuil,modificateur)local seuilEffectif= seuil+modificateur if(seuilEffectif < 1 and true)then seuilEffectif=1 end return seuilEffectif end function GetDegresReussite(d100,seuil)local difference= (seuil - d100)/10 local degresReussite=0 if(difference > 0 and true)then degresReussite=math.floor(difference)elseif(difference < 0 and true)then degresReussite=math.ceil(difference)end degresReussite= degresReussite+GetExtraDR(seuil)return degresReussite end function GetExtraDR(seuilDeBase)local extraDR=0 if OptionDRSupplementairePourSeuilsSuperieursA100 then if(seuilDeBase > 100 and true)then extraDR=math.floor((seuilDeBase - 100)/10)end else extraDR=0 end return extraDR end function GetLocalisationDegats(d100)if(d100 >= 1 and d100 <= 9)then return"T√™te"elseif(d100 >= 10 and d100 <= 24)then return"Bras secondaire"elseif(d100 >= 25 and d100 <= 44)then return"Bras principal"elseif(d100 >= 45 and d100 <= 79)then return"Corps"elseif(d100 >= 80 and d100 <= 89)then return"Jambe gauche"elseif(d100 >= 90 and d100 <= 100)then return"Jambe droite"end end function GetLibelleLocalisationDegats(localisationDegats)local libelleLocalisationDegats=""if localisationDegats=="T√™te"then libelleLocalisationDegats="√† la T√™te"elseif localisationDegats=="Bras secondaire"then libelleLocalisationDegats="au niveau du Bras gauche (ou du bras secondaire)"elseif localisationDegats=="Bras principal"then libelleLocalisationDegats="au niveau du Bras droit (ou du bras principal)"elseif localisationDegats=="Corps"then libelleLocalisationDegats="au niveau du Corps"elseif localisationDegats=="Jambe gauche"then libelleLocalisationDegats="au niveau de la Jambe gauche"elseif localisationDegats=="Jambe droite"then libelleLocalisationDegats="au niveau de la Jambe droite"end return libelleLocalisationDegats end function GetLibelleEffetMaladresse(d100)if d100 >= 1 and d100 <= 20 then return"%s se blesse tout seul en attaquant, et perd un Point de Blessure sans tenir compte du Bonus d'Endurance ou des Points d'Armure."elseif d100 >= 21 and d100 <= 40 then return"L'arme de Corps-√†-Corps de %s s'√©br√®che salement, ou l'arme de tir √† distance ne fonctionne pas ou se trouve sur le point de se briser. L'arme subit 1 point de D√©g√¢ts. Au prochain Round, %s agira en dernier sans tenir compte de l'ordre d'initiative, des talents ni de toute r√®gle sp√©ciale pendant que le porteur g√®re la situation."elseif d100 >= 41 and d100 <= 60 then return"%s a mal n√©goci√© sa manoeuvre, ce qui le met en mauvaise posture. Au cours du prochain round, votre action subira une p√©nalit√© de -10."elseif d100 >= 61 and d100 <= 70 then return"%s tr√©buche franchement et peine √† se redresser, il perd son prochain Mouvement."elseif d100 >= 71 and d100 <= 80 then return"%s ne tient pas son arme correctement ou laisse tomber ses munitions, il perd sa prochaine Action."elseif d100 >= 81 and d100 <= 90 then return"%s effectue un mouvement trop ample ou tr√©buche et se tord la cheville, subissant un traumatisme [i]D√©chirure musculaire (Mineure)[/i] comptant comme une Blessure critique."elseif d100 >= 91 and d100 <= 100 then return"%s manque compl√®tement son attaque et touche un alli√© au hasard √† distance en utilisant le chiffre des unit√©s du lancer de d√©s pour d√©terminer le DR. Si personne n'est √† distance, il se blesse tout seul et obtient l'√âtat [i]Sonn√©[/i]."end end function GetLibelleEffetCoupCritiques(localisationDegats)local jet=rpg.roll.dice(2,0,9)local d1=jet[1]local d2=jet[2]local d100=GetD100(d1,d2)local description=""local ptsBlessure=0 local effetsSupplementaires="ü§ò"if localisationDegats=="T√™te"then if d100 >= 1 and d100 <= 10 then description="Blessure spectaculaire"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 11 and d100 <= 20 then description="Coupure mineure"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 21 and d100 <= 25 then description="Coup √† l'oeil"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 26 and d100 <= 30 then description="Frappe √† l'oreille"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 31 and d100 <= 35 then description="Coup percutant"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 36 and d100 <= 40 then description="Oeil au beurre noir"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 41 and d100 <= 45 then description="Oreille tranch√©e"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 46 and d100 <= 50 then description="En plein front"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 51 and d100 <= 55 then description="M√¢choire fractur√©e"ptsBlessure=3 effetsSupplementaires="ü§ò"elseif d100 >= 56 and d100 <= 60 then description="Blessure majeure √† l'oeil"ptsBlessure=3 effetsSupplementaires="ü§ò"elseif d100 >= 61 and d100 <= 65 then description="Blessure majeure √† l'oreille"ptsBlessure=3 effetsSupplementaires="ü§ò"elseif d100 >= 66 and d100 <= 70 then description="Nez cass√©"ptsBlessure=3 effetsSupplementaires="ü§ò"elseif d100 >= 71 and d100 <= 75 then description="M√¢choire cass√©e"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 76 and d100 <= 80 then description="Commotion c√©r√©brale"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 81 and d100 <= 85 then description="Bouche explos√©e"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 86 and d100 <= 90 then description="Oreille mutil√©e"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 91 and d100 <= 93 then description="≈íil crev√©"ptsBlessure=5 effetsSupplementaires="ü§ò"elseif d100 >= 94 and d100 <= 96 then description="Coup d√©figurant"ptsBlessure=5 effetsSupplementaires="ü§ò"elseif d100 >= 97 and d100 <= 99 then description="M√¢choire mutil√©e"ptsBlessure=5 effetsSupplementaires="ü§ò"elseif d100==100 then description="Mort"ptsBlessure=666 effetsSupplementaires="ü§ò"end elseif localisationDegats == "Bras secondaire"or localisationDegats == "Bras principal"then if d100 >= 1 and d100 <= 10 then description="Choc au bras"ptsBlessure=1 effetsSupplementaires= "Le bras "..localisationDegats .. " de %s prend un choc au cours de l'attaque. %s l√¢che ce qu'il tenait."elseif d100 >= 11 and d100 <= 20 then description="Coupure mineure"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 21 and d100 <= 25 then description="Torsion"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 26 and d100 <= 30 then description="Choc violent au bras"ptsBlessure=2 effetsSupplementaires= "%s re√ßoit un coup particuli√®rement violent au "..localisationDegats .. " et l√¢che ce qu'il avait dans la main, cette derni√®re restant inutilisable pendant 1D10 - Bonus d'Endurance Rounds (minimum 1). Pendant ce temps, consid√©rez votre main comme perdue (voir Membres Amput√©s, p180)."elseif d100 >= 31 and d100 <= 35 then description="D√©chirure musculaire"ptsBlessure=2 effetsSupplementaires= "Le coup √©crase l'avant-bras du "..localisationDegats .. " de %s. +1 √âtat [i]H√©morragique[/i] et +1 Traumatisme [i]D√©chirure musculaire (Mineure)[/i]."elseif d100 >= 36 and d100 <= 40 then description="Main ensanglant√©e"ptsBlessure=2 effetsSupplementaires= "La main du "..localisationDegats .. " de %s est bien entaill√©e. Le sang rend la prise glissante avec cette main. +1 √âtat [i]H√©morragique[/i]. Test de [i]Dext√©rit√© (Accessible)[/i] pour effectuer toute action avec un objet dans la main, sinon il √©chappe des mains."elseif d100 >= 41 and d100 <= 45 then description="Clef de bras"ptsBlessure=2 effetsSupplementaires= "L'articulation du "..localisationDegats .. " de %s est pratiquement arrach√©e. La main correspondante l√¢che ce qu'elle tenait, le bras est inutilisable pendant 1D10 Rounds."elseif d100 >= 46 and d100 <= 50 then description="Blessure b√©ante"ptsBlessure=3 effetsSupplementaires= "Le coup ouvre une blessure b√©ante. +2 √âtats [i]H√©morragique[/i]. Jusqu'√† ce que %s soit soign√© par Chirurgie afin de recoudre la blessure, tout nouveau D√©g√¢t au "..localisationDegats .. " redonnera +1 √âtat [i]H√©morragique[/i], la blessure s'√©tant r√©ouverte."elseif d100 >= 51 and d100 <= 55 then description="Cassure nette"ptsBlessure=3 effetsSupplementaires= "Un craquement significatif se fait entendre au moment o√π le coup s'abat sur le "..localisationDegats .. " de %s. La main correspondante l√¢che ce qu'elle tenait. +1 Traumatisme [i]Fracture (Mineure)[/i]. +1 √âtat [i]Sonn√©[/i] en cas d'√©chec √† un Test de [i]R√©sistance (Complexe)[/i]."elseif d100 >= 56 and d100 <= 60 then description="Ligament rompu"ptsBlessure=3 effetsSupplementaires= "%s l√¢che imm√©diatement ce qu'il tenait dans la main de son "..localisationDegats .. ". +1 Traumatisme [i]D√©chirure musculaire (Majeure)[/i]"elseif d100 >= 61 and d100 <= 65 then description="Coupure profonde"ptsBlessure=3 effetsSupplementaires= "+2 √âtats [i]H√©morragique[/i] d√ªs √† la forte mutilation du "..localisationDegats .. " de %s. +1 √âtat [i]Sonn√©[/i], +1 Traumatisme [i]D√©chirure musculaire (Mineure)[/i], +1 √âtat [i]Inconscient[/i] en cas d'√©chec √† un Test de [i]R√©sistance (Difficile)[/i]."elseif d100 >= 66 and d100 <= 70 then description="Art√®re endommag√©e"ptsBlessure=4 effetsSupplementaires= "+4 √âtats [i]H√©morragique[/i]. Jusqu'√† ce que %s soit soign√© par Chirurgie afin de recoudre la blessure, tout nouveau D√©g√¢t au "..localisationDegats .. " redonnera +2 √âtat [i]H√©morragique[/i], la blessure s'√©tant r√©ouverte."elseif d100 >= 71 and d100 <= 75 then description="Coude fracass√©"ptsBlessure=4 effetsSupplementaires= "Le coup fracasse le coude du "..localisationDegats .. " de %s, faisant voler en √©clats os et cartilage. %s l√¢che imm√©diatement ce qu'il tenait dans cette main, et subit +1 Traumatisme [i]Fracture (Majeure)[/i]"elseif d100 >= 76 and d100 <= 80 then description="√âpaule lux√©e"ptsBlessure=4 effetsSupplementaires= "Le "..localisationDegats .. " de %s est d√©mis de son logement. %s l√¢che imm√©diatement ce qu'il tenait dans cette main. +1 √âtat [i]Sonn√©[/i] et +1 √âtat [i]√Ä terre[/i] en cas d'√©chec √† un Test de [i]R√©sistance (Difficile)[/i]. √âtat [i]Sonn√©[/i] conserv√© jusqu'√† b√©n√©ficier d'Aide M√©dicale. Un Test √âtendu de Gu√©rison avec 6 DR est n√©cessaire pour recouvrer l'usage du bras. Les tests utilisant ce bras subissent une p√©nalit√© de -10 pendant 1D10 jours."elseif d100 >= 81 and d100 <= 85 then description="Doigt sectionn√©"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 86 and d100 <= 90 then description="Main ouverte"ptsBlessure=5 effetsSupplementaires= "La main du "..localisationDegats .. " de %s s'ouvre sous la puissance du coup. Un Doigt est perdu ‚Äî [b]Amputation (Complexe)[/b]. +2 √âtats [i]H√©morragique[/i] et +1 √âtat [i]Sonn√©[/i]. Pour chaque Round sans Aide M√©dicale, un autre Doigt est perdu. Si tous les doigts sont perdus, la main est perdue. ‚Äî [b]Amputation (Complexe)[/b]"elseif d100 >= 91 and d100 <= 93 then description="Biceps d√©chiquet√©"ptsBlessure=5 effetsSupplementaires= "Le coup s√©pare presque enti√®rement le biceps et le tendon de l'os du "..localisationDegats .. " de %s, laissant une blessure effrayante dont le sang gicle jusque sur son adversaire. %s l√¢che imm√©diatement ce qu'il tenait dans cette main. +1 Traumatisme [i]D√©chirure musculaire (Majeure)[/i], +2 √âtats [i]H√©morragique[/i] et +1 √âtat [i]Sonn√©[/i]"elseif d100 >= 94 and d100 <= 96 then description="Main mutil√©e"ptsBlessure=5 effetsSupplementaires= "La main du "..localisationDegats .. " de %s n'est plus qu'un tas de chair h√©morragique. La main est perdue ‚Äî [b]Amputation (Difficile)[/b]. +2 √âtats [i]H√©morragique[/i]. +1 √âtat [i]Sonn√©[/i] et +1 √âtat [i]√Ä terre[/i] en cas d'√©chec √† un Test de [i]R√©sistance (Difficile)[/i]"elseif d100 >= 97 and d100 <= 99 then description="Tendons coup√©s"ptsBlessure=5 effetsSupplementaires= "Les tendons sont sectionn√©s par la force du coup et le "..localisationDegats .. " de %s est inutilisable ‚Äî [b]Amputation (Difficile)[/b]. +3 √âtats [i]H√©morragique[/i], +1 √âtat [i]√Ä terre[/i], +1 √âtat [i]Sonn√©[/i]. +1 √âtat [i]Inconscient[/i] en cas d'√©chec √† un Test de [i]R√©sistance (Difficile)[/i]. "elseif d100==100 then description="D√©membrement fatal"ptsBlessure=666 effetsSupplementaires= "Le "..localisationDegats .. " de %s est coup√©, faisant gicler le sang des art√®res jusqu'√† 1D3 m√®tres dans une direction al√©atoire (voir [b]Dispersion[/b]). La mort de %s est instantan√©e, et son corps s'effondre sans vie."end elseif localisationDegats=="Corps"then if d100 >= 1 and d100 <= 10 then description="Rien qu'une √©gratignure !"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 11 and d100 <= 20 then description="Coup au ventre"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 21 and d100 <= 25 then description="Coup bas"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 26 and d100 <= 30 then description="Torsion du dos"ptsBlessure=1 effetsSupplementaires="ü§ò"elseif d100 >= 31 and d100 <= 35 then description="Souffle coup√©"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 36 and d100 <= 40 then description="Bleus aux c√¥tes"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 41 and d100 <= 45 then description="Clavicule tordue"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 46 and d100 <= 50 then description="Chairs d√©chir√©es"ptsBlessure=2 effetsSupplementaires="ü§ò"elseif d100 >= 51 and d100 <= 55 then description="C√¥tes fractur√©es"ptsBlessure=3 effetsSupplementaires="ü§ò"elseif d100 >= 56 and d100 <= 60 then description="Blessure b√©ante"ptsBlessure=3 effetsSupplementaires= "+3 √âtats [i]H√©morragique[/i]. Jusqu'√† ce que %s soit soign√© par Chirurgie afin de recoudre la blessure, tout nouveau D√©g√¢t au "..localisationDegats .. " redonnera +1 √âtat [i]H√©morragique[/i], la blessure s'√©tant r√©ouverte."elseif d100 >= 61 and d100 <= 65 then description="Entaille douloureuse"ptsBlessure=3 effetsSupplementaires="ü§ò"elseif d100 >= 66 and d100 <= 70 then description="D√©g√¢ts art√©riels"ptsBlessure=3 effetsSupplementaires= "+4 √âtats [i]H√©morragique[/i]. Jusqu'√† ce que %s soit soign√© par Chirurgie afin de recoudre la blessure, tout nouveau D√©g√¢t au "..localisationDegats .. " redonnera +2 √âtats [i]H√©morragique[/i], la blessure s'√©tant r√©ouverte."elseif d100 >= 71 and d100 <= 75 then description="Dos froiss√©"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 76 and d100 <= 80 then description="Hanche fractur√©e"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 81 and d100 <= 85 then description="Blessure majeure au torse"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 86 and d100 <= 90 then description="Blessure au ventre"ptsBlessure=4 effetsSupplementaires="ü§ò"elseif d100 >= 91 and d100 <= 93 then description="Cage thoracique perfor√©e"ptsBlessure=5 effetsSupplementaires="ü§ò"elseif d100 >= 94 and d100 <= 96 then description="Clavicule cass√©e"ptsBlessure=5 effetsSupplementaires="ü§ò"elseif d100 >= 97 and d100 <= 99 then description="H√©morragie interne"ptsBlessure=5 effetsSupplementaires="ü§ò"elseif d100==100 then description="√âventr√©"ptsBlessure=666 effetsSupplementaires="ü§ò"end elseif localisationDegats == "Jambe gauche"or localisationDegats == "Jambe droite"then description="Gluglu"ptsBlessure=0 effetsSupplementaires="ü§ò"end return d1,d2,description,ptsBlessure,effetsSupplementaires end function EvaluateTest(typetest,seuilBase,seuilEffectif,difficulte,d1,d2)typetest=string.lower(typetest)local syntheseResultat=""if typetest=="simple"then if seuilEffectif and difficulte then local myheader= "Test Simple, difficult√© "..GetLibelleDifficulte(difficulte) .. ", maximum de " .. seuilEffectif local myrolls= "["..'div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]' .. d1 .. "[" .. "/div]"myrolls= myrolls.."[" .. 'div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]' .. d2 .. "[" .. "/div]"local d100=GetD100(d1,d2)local succes=IsSuccess(d100,seuilEffectif)local critique=IsCritical(typetest,d1,d2)local libelleResultat=""if succes==true then libelleResultat="Succ√®s"else libelleResultat="√âchec"end local libelleCritique=""if critique==true then libelleCritique="Critique"else libelleCritique=""end local myresults=string.format("%d contre %d est un %s %s",d100,seuilEffectif,libelleResultat,libelleCritique)local myfooter=""if succes and not critique then myfooter=string.format("L'action du personnage est [u]une r√©ussite[/u].")elseif succes and critique then myfooter=string.format("L'action du personnage est [u]une r√©ussite stup√©fiante !![/u]")elseif not succes and not critique then myfooter=string.format("L'action du personnage est clairement [u]un √©chec[/u].")elseif not succes and critique then myfooter=string.format("L'action du personnage est [u]un √©chec stup√©fiant ![/u] Le personnage √©choue lamentablement, tout est all√© de travers et les cons√©quences de cet √©chec sont catastrophiques !")end return rpg.smf.save(myheader,myrolls,myresults,myfooter,"wfrp4")end elseif typetest=="spectaculaire"then if seuilEffectif and difficulte then local myheader= "Test Spectaculaire, difficult√© "..GetLibelleDifficulte(difficulte) .. ", maximum de " .. seuilEffectif local myrolls= '[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'..d1 .. "[/div]"myrolls= myrolls..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]' .. d2 .. "[/div]"local d100=GetD100(d1,d2)local succes=IsSuccess(d100,seuilEffectif)local critique=IsCritical(typetest,d1,d2)local degresReussite=GetDegresReussite(d100,seuilEffectif)degresReussite= degresReussite+GetExtraDR(seuilBase)local libelleResultat=""local libelleAmpleur=""local libelleAction=""if succes==true then if critique then syntheseResultat=string.format("%d contre %d donne un Succ√®s avec %d Degr√©s de R√©ussite, mais c'est surtout un jet Critique, obtenant ainsi un Succ√®s Stup√©fiant !",d100,seuilEffectif,degresReussite)libelleAction="Gr√¢ce √† ce jet de d√©s critique, l'action du personnage est un [u]Succ√®s Stup√©fiant[/u] ! Les r√©sultats d√©passent ce qu'il esp√©rait, on n'aurait pas pu imaginer mieux !"else if degresReussite>=6 then syntheseResultat=string.format("%d contre %d donne un Succ√®s avec %d Degr√©s de R√©ussite, ce qui est un [u]Succ√®s Stup√©fiant[/u] !",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est une [u]r√©ussite stup√©fiante[/u] ! Les r√©sultats d√©passent ce qu'il esp√©rait, on n'aurait pas pu imaginer mieux !"elseif degresReussite == 4 or degresReussite == 5 then syntheseResultat=string.format("%d contre %d donne un Succ√®s avec %d Degr√©s de R√©ussite, ce qui est un [u]Succ√®s Impressionnant[/u] !",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est [u]r√©ussie avec style[/u] et les r√©sultats sont absolument parfaits."elseif degresReussite == 2 or degresReussite == 3 then syntheseResultat=string.format("%d contre %d donne un Succ√®s avec %d Degr√©s de R√©ussite",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est [u]une r√©ussite[/u]."elseif degresReussite == 0 or degresReussite == 1 then syntheseResultat=string.format("%d contre %d est un Succ√®s mais avec %d Degr√© de R√©ussite, c'est un [u]Succ√®s Minime[/u]...",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est [u]plus ou moins r√©ussie[/u], mais ce n'est pas parfait et des effets inattendus sont possibles."end end elseif succes==false then if critique then syntheseResultat=string.format("%d contre %d donne un √âchec avec %d Degr√©s de R√©ussite, mais c'est surtout un jet Critique, obtenant ainsi un √âchec Stup√©fiant !",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est [u]un √âchec Stup√©fiant ![/u] Le personnage √©choue lamentablement, tout est all√© de travers et les cons√©quences de cet √©chec sont catastrophiques !"else if degresReussite<=-6 then syntheseResultat=string.format("%d contre %d donne un √âchec avec %d Degr√©s de R√©ussite, ce qui est un [u]√âchec Stup√©fiant[/u] !",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est [u]un √âchec Stup√©fiant ![/u] Le personnage √©choue lamentablement, tout est all√© de travers et les cons√©quences de cet √©chec sont catastrophiques !"elseif degresReussite == -4 or degresReussite == -5 then syntheseResultat=string.format("%d contre %d donne un √âchec avec %d Degr√©s de R√©ussite, ce qui est un [u]√âchec Impressionnant[/u] !",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est un [u]√©chec complet[/u], amenant m√™me quelques cons√©quences collat√©rales n√©gatives."elseif degresReussite == -2 or degresReussite == -3 then syntheseResultat=string.format("%d contre %d donne un √âchec avec %d Degr√©s de R√©ussite.",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage est clairement [u]un √©chec[/u]."elseif degresReussite == 0 or degresReussite == -1 then syntheseResultat=string.format("%d contre %d donne un √âchec mais avec %d Degr√©s de R√©ussite, c'est un [u]√âchec Minime[/u]...",d100,seuilEffectif,degresReussite)libelleAction="L'action du personnage [u]√©choue de peu[/u], avec peut-√™tre des progr√®s mineurs ou la possibilit√© de retenter sa chance au prochain Round, si la situation s'y pr√™te."end end end local myresults=syntheseResultat local myfooter=libelleAction return rpg.smf.save(myheader,myrolls,myresults,myfooter,"wfrp4")end else return rpg.smf.save("Type de test inconnu","myrolls","myresults","myfooter","wfrp4")end end function EvaluateTestOppose(protagoniste1,seuilBase1,seuilEffectif1,difficulte1,d1_1,d2_1,protagoniste2,seuilBase2,seuilEffectif2,difficulte2,d1_2,d2_2)local myheader=""local libelleProtagoniste1= protagoniste1 or"Protagoniste 1"local libelleProtagoniste2= protagoniste2 or"Protagoniste 2"myheader= myheader..'[div style="display: flex; color: white"]'myheader= myheader..'[div style="display: flex; flex-direction: column; width: 100%"]'myheader= myheader..'[span style="font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px"]'myheader= myheader.."Test Oppos√©"myheader= myheader.."[/span]"myheader= myheader..'[div style="display: flex; width: 100%"]'myheader= myheader..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'myheader= myheader..'[div style="display: flex; font-weight: bold"]'myheader= myheader..libelleProtagoniste1 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Seuil de base : " .. seuilBase1 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Difficult√© " .. GetLibelleDifficulte(difficulte1) .. " (" .. GetLibelleModificateurDifficulte(difficulte1) .. ")"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Maximum : " .. seuilEffectif1 myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader..'[hr style="border: color; margin: 5px"]'myheader= myheader..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'myheader= myheader..'[div style="display: flex; font-weight: bold"]'myheader= myheader..libelleProtagoniste2 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Seuil de base : " .. seuilBase2 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Difficult√© " .. GetLibelleDifficulte(difficulte2) .. " (" .. GetLibelleModificateurDifficulte(difficulte2) .. ")"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Maximum : " .. seuilEffectif2 myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader.."[/div]"local myrolls=""myrolls= myrolls..'[div style="display: flex"]'myrolls= myrolls..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myrolls= myrolls..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d1_1 myrolls= myrolls.."[/div]"myrolls= myrolls..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d2_1 myrolls= myrolls.."[/div]"myrolls= myrolls.."[/div]"myrolls= myrolls..'[hr style="border: color; margin: 5px"]'myrolls= myrolls..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myrolls= myrolls..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d1_2 myrolls= myrolls.."[/div]"myrolls= myrolls..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d2_2 myrolls= myrolls.."[/div]"myrolls= myrolls.."[/div]"myrolls= myrolls.."[/div]"local d100_1=GetD100(d1_1,d2_1)local d100_2=GetD100(d1_2,d2_2)local succes1=IsSuccess(d100_1,seuilEffectif1)local succes2=IsSuccess(d100_2,seuilEffectif2)local critique1=IsCritical("oppose",d1_1,d2_1)local critique2=IsCritical("oppose",d1_2,d2_2)local degresReussite1=GetDegresReussite(d100_1,seuilEffectif1)local degresReussite2=GetDegresReussite(d100_2,seuilEffectif2)local libelleResultat1=""local libelleResultat2=""local syntheseResultat1=""local syntheseResultat2=""local libelleAmpleur1=""local libelleAmpleur2=""local libelleAction1=""local libelleAction2=""if critique1 then libelleAmpleur1="Critique"if(degresReussite1 >= 0 and degresReussite1 < 6)then degresReussite1=6 elseif(degresReussite1 <= 0 and degresReussite1 > -6)then degresReussite1=-6 end end if critique2 then libelleAmpleur2="Critique"if(degresReussite2 >= 0 and degresReussite2 < 6)then degresReussite2=6 elseif(degresReussite2 <= 0 and degresReussite2 > -6)then degresReussite2=-6 end end degresReussite1= degresReussite1+GetExtraDR(seuilBase1)degresReussite2= degresReussite2+GetExtraDR(seuilBase2)if succes1 then libelleResultat1="Succ√®s"else libelleResultat1="√âchec"end if succes2 then libelleResultat2="Succ√®s"else libelleResultat2="√âchec"end syntheseResultat1=string.format("%s %s[br/]avec [u]%d Degr√©s de R√©ussite[/u]",libelleResultat1,libelleAmpleur1,degresReussite1)syntheseResultat2=string.format("%s %s[br/]avec [u]%d Degr√©s de R√©ussite[/u]",libelleResultat2,libelleAmpleur2,degresReussite2)local myresults=""myresults= myresults..'[div style="display: flex"]'myresults= myresults..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myresults= myresults..'[span class="" style="color: white"]'myresults= myresults..syntheseResultat1 myresults= myresults.."[/span]"myresults= myresults.."[/div]"myresults= myresults..'[hr style="border: color; margin: 5px"]'myresults= myresults..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myresults= myresults..'[span class="" style="color: white"]'myresults= myresults..syntheseResultat2 myresults= myresults.."[/span]"myresults= myresults.."[/div]"myresults= myresults.."[/div]"local vainqueur=""local perdant=""local libelleAction=""if(degresReussite1 > degresReussite2 and true)then libelleAction=string.format("[u]%s remporte le Test[/u][br/]avec %d Degr√©s de R√©ussite d'√©cart.",libelleProtagoniste1, degresReussite1-degresReussite2)vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(degresReussite1 < degresReussite2 and true)then libelleAction=string.format("[u]%s remporte le Test[/u][br/]avec %d Degr√©s de R√©ussite d'√©cart.",libelleProtagoniste2, degresReussite2-degresReussite1)vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(degresReussite1 == degresReussite2 and true)then if succes1 and not succes2 then libelleAction=string.format("[u]%s remporte le Test[/u], d√©partag√© par le Succ√®s du lancer",libelleProtagoniste1)vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif succes2 and not succes1 then libelleAction=string.format("[u]%s remporte le Test[/u], d√©partag√© par le Succ√®s du lancer.",libelleProtagoniste2)vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(succes1 and succes1)or(not succes1 and not succes2)then if seuilEffectif1>seuilEffectif2 then libelleAction=string.format("[u]%s remporte le Test de peu[/u], d√©partag√© par le Seuil du Test.",libelleProtagoniste1)vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(seuilEffectif1 < seuilEffectif2 and true)then libelleAction=string.format("[u]%s remporte le Test[/u], d√©partag√© par le Seuil du Test.",libelleProtagoniste2)vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(seuilEffectif1 == seuilEffectif2 and true)then if seuilBase1>seuilBase2 then libelleAction=string.format("[u]%s remporte le Test[/u], d√©partag√© par le Score de comp√©tence.",libelleProtagoniste1)vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(seuilBase1 < seuilBase2 and true)then libelleAction=string.format("[u]%s remporte le Test[/u], d√©partag√© par le Score de comp√©tence.",libelleProtagoniste2)vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(seuilBase1 == seuilBase2 and true)then if(d100_1 < d100_2 and true)then libelleAction=string.format("[u]%s remporte le Test[/u], d√©partag√© par le Lancer de d√©.",libelleProtagoniste1)vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(d100_1 > d100_1 and true)then libelleAction=string.format("[u]%s remporte le Test[/u], d√©partag√© par le Lancer de d√©.",libelleProtagoniste2)vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(d100_1 == d100_2 and true)then libelleAction=string.format("[u]Aucun protagoniste ne remporte le Test, c'est une √©galit√© parfaite[/u].")end end end end end local libelleActionBis=""if succes1 and succes2 then libelleActionBis= libelleActionBis..string.format( "Les deux protagonistes ont r√©ussi, mais %s a tout de m√™me pris le dessus sur %s.", vainqueur, perdant )elseif(succes1 and not succes2)or(succes2 and not succes1)then libelleActionBis= libelleActionBis..string.format("Le r√©sultat est clair, sans ambig√ºit√© : %s a r√©ussi et %s a √©chou√©.", vainqueur, perdant)elseif not succes1 and not succes2 then libelleActionBis= libelleActionBis.."Toutefois, les deux protagonistes ont √©chou√©, quel duel de bras cass√©s !"end local myfooter=""myfooter= myfooter..'[hr style="border: color; margin: 5px; "]'myfooter= myfooter..'[div style="display: flex;margin-top: 10px"]'myfooter= myfooter..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myfooter= myfooter..'[div style="color: white"]'myfooter= myfooter..'[div style="color: white; font-size: 1.2em; font-weight: bold; padding-bottom:5px; line-height: 1.4em"]' .. libelleAction .. "[/div]"myfooter= myfooter..'[div style="color: white; font-weight: bold; padding-top:5px"]' .. libelleActionBis .. "[/div]"myfooter= myfooter.."[/div]"myfooter= myfooter.."[/div]"myfooter= myfooter.."[/div]"return rpg.smf.save(myheader,myrolls,myresults,myfooter,"wfrp4")end function EvaluateTestCorpsACorps(protagoniste1,seuilBase1,seuilEffectif1,difficulte1,avantage1,d1_1,d2_1,bonusForce1,protagoniste2,seuilBase2,seuilEffectif2,difficulte2,avantage2,d1_2,d2_2)local myheader=""local libelleProtagoniste1= protagoniste1 or"Protagoniste 1"local libelleProtagoniste2= protagoniste2 or"Protagoniste 2"local syntheseResultat=""myheader= myheader..'[div style="display: flex; color: white"]'myheader= myheader..'[div style="display: flex; flex-direction: column; width: 100%"]'myheader= myheader..'[span style="font-size: 1.2em; font-weight: bold; text-align: center; padding-bottom: 10px"]'myheader= myheader.."Attaque au Corps-√†-Corps"myheader= myheader.."[/span]"myheader= myheader..'[div style="display: flex; width: 100%"]'myheader= myheader..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'myheader= myheader..'[div style="display: flex; font-weight: bold"]'myheader= myheader.."Attaquant"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex; font-weight: bold"]'myheader= myheader..libelleProtagoniste1 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Seuil de base : " .. seuilBase1 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Difficult√© " .. GetLibelleDifficulte(difficulte1) .. " (" .. GetLibelleModificateurDifficulte(difficulte1) .. ")"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader..avantage1 .. " Avantages (" .. GetLibelleModificateurAvantage(avantage1) .. ")"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Seuil effectif : " .. seuilEffectif1 myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader..'[hr style="border: color; margin: 5px"]'myheader= myheader..'[div style="display: flex; flex-direction: column; flex-grow: 1; align-items: center"]'myheader= myheader..'[div style="display: flex; font-weight: bold"]'myheader= myheader.."D√©fenseur"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex; font-weight: bold"]'myheader= myheader..libelleProtagoniste2 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Seuil de base : " .. seuilBase2 myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Difficult√© " .. GetLibelleDifficulte(difficulte2) .. " (" .. GetLibelleModificateurDifficulte(difficulte2) .. ")"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader..avantage2 .. " Avantages (" .. GetLibelleModificateurAvantage(avantage2) .. ")"myheader= myheader.."[/div]"myheader= myheader..'[div style="display: flex"]'myheader= myheader.."Seuil effectif : " .. seuilEffectif2 myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader.."[/div]"myheader= myheader.."[/div]"local myrolls=""myrolls= myrolls..'[div style="display: flex"]'myrolls= myrolls..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myrolls= myrolls..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d1_1 myrolls= myrolls.."[/div]"myrolls= myrolls..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d2_1 myrolls= myrolls.."[/div]"myrolls= myrolls.."[/div]"myrolls= myrolls..'[hr style="border: color; margin: 5px"]'myrolls= myrolls..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myrolls= myrolls..'[div class="yellow_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d1_2 myrolls= myrolls.."[/div]"myrolls= myrolls..'[div class="white_d10" style="display: inline-table;text-align: center;vertical-align:middle;color: black;height: 24px;background-size: cover;width: 28px;text-shadow: -1px -1px 0px rgba(255, 227, 0, 0.3), 1px 1px 1px rgba(168, 129, 11, 0.8);"]'myrolls= myrolls..d2_2 myrolls= myrolls.."[/div]"myrolls= myrolls.."[/div]"myrolls= myrolls.."[/div]"local d100_1=GetD100(d1_1,d2_1)local d100_2=GetD100(d1_2,d2_2)local succes1=IsSuccess(d100_1,seuilEffectif1)local succes2=IsSuccess(d100_2,seuilEffectif2)local critique1=IsCritical("corps-a-corps",d1_1,d2_1)local critique2=IsCritical("corps-a-corps",d1_2,d2_2)local degresReussite1=GetDegresReussite(d100_1,seuilEffectif1)local degresReussite2=GetDegresReussite(d100_2,seuilEffectif2)local libelleResultat1=""local libelleResultat2=""local libelleAmpleur1=""local libelleAmpleur2=""local syntheseResultat1=""local syntheseResultat2=""local libelleAction=""local libelleAction1=""local libelleAction2=""if critique1 then libelleAmpleur1="Critique"end if critique2 then libelleAmpleur2="Critique"end degresReussite1= degresReussite1+GetExtraDR(seuilBase1)degresReussite2= degresReussite2+GetExtraDR(seuilBase2)if succes1 then libelleResultat1="Succ√®s"else libelleResultat1="√âchec"end if succes2 then libelleResultat2="Succ√®s"else libelleResultat2="√âchec"end syntheseResultat1=string.format("%s %s[br/]avec [u]%d Degr√©s de R√©ussite[/u]",libelleResultat1,libelleAmpleur1,degresReussite1)syntheseResultat2=string.format("%s %s[br/]avec [u]%d Degr√©s de R√©ussite[/u]",libelleResultat2,libelleAmpleur2,degresReussite2)local myresults=""myresults= myresults..'[div style="display: flex"]'myresults= myresults..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myresults= myresults..'[span class="" style="color: white"]'myresults= myresults..syntheseResultat1 myresults= myresults.."[/span]"myresults= myresults.."[/div]"myresults= myresults..'[hr style="border: color; margin: 5px"]'myresults= myresults..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myresults= myresults..'[span class="" style="color: white"]'myresults= myresults..syntheseResultat2 myresults= myresults.."[/span]"myresults= myresults.."[/div]"myresults= myresults.."[/div]"local vainqueur=""local perdant=""local localisationDegats1=""local localisationDegats2=""local libelleDegats1=""local libelleDegats2=""local ptsBlessureCritique1=0 local ptsBlessureCritique2=0 local effetsSupplementairesCritique1=""local effetsSupplementairesCritique2=""local d1_1_critique=0 local d2_1_critique=0 local d1_2_critique=0 local d2_2_critique=0 if critique1 then localisationDegats1=GetLocalisationDegats(rpg.roll.dice(1,1,100)[1])libelleDegats1=GetLibelleEffetCoupCritiques(localisationDegats1)d1_1_critique,d2_1_critique,libelleDegats1,ptsBlessureCritique1,effetsSupplementairesCritique1=GetLibelleEffetCoupCritiques(localisationDegats1)else localisationDegats1=GetLocalisationDegats(d100_1)libelleDegats1=GetLibelleLocalisationDegats(localisationDegats1)end if critique2 then localisationDegats2=GetLocalisationDegats(rpg.roll.dice(1,1,100)[1])d1_2_critique,d2_2_critique,libelleDegats2,ptsBlessureCritique2,effetsSupplementairesCritique2=GetLibelleEffetCoupCritiques(localisationDegats2)end if(succes1 and critique1)then libelleAction1= libelleAction1..string.format( "[u]%s porte un Coup Critique[/u] touchant %s avec pour effet [b]%s[/b]. Le coup outrepasse l'armure √©ventuelle, et occasionne directement %d D√©g√¢ts, avec des effets suppl√©mentaires : %s", libelleProtagoniste1, libelleProtagoniste2, libelleDegats1, ptsBlessureCritique1, effetsSupplementairesCritique1 )end if(succes2 and critique2)then libelleAction2= libelleAction2..string.format( "[u]En se d√©fendant de l'attaque de %s, %s r√©ussit un Coup Critique[/u] avec pour effet [b]%s[/b]. Le coup outrepasse l'armure √©ventuelle, et occasionne directement %d D√©g√¢ts, avec des effets suppl√©mentaires : %s", libelleProtagoniste1, libelleProtagoniste2, libelleDegats2, ptsBlessureCritique2, effetsSupplementairesCritique2 )end libelleAction= libelleAction1.."[br/]" .. libelleAction2 .. "[br/]"if(degresReussite1 > degresReussite2 and true)then libelleAction= libelleAction..string.format( "[u]%s attaque avec succ√®s[/u] et touche %s %s. Il occasionne des D√©g√¢ts √† hauteur de %d DR + %d ", libelleProtagoniste1, libelleProtagoniste2, libelleDegats1, degresReussite1 - degresReussite2, bonusForce1 )vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(degresReussite1 < degresReussite2 and true)then libelleAction= libelleAction..string.format( "[u]%s remporte le Test[/u][br/]avec %d Degr√©s de R√©ussite d'√©cart.", libelleProtagoniste2, degresReussite2 - degresReussite1 )vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(degresReussite1 == degresReussite2 and true)then if succes1 and not succes2 then libelleAction= libelleAction..string.format("[u]%s remporte le Test[/u], d√©partag√© par le Succ√®s du lancer", libelleProtagoniste1)vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif succes2 and not succes1 then libelleAction= libelleAction..string.format("[u]%s remporte le Test[/u], d√©partag√© par le Succ√®s du lancer.", libelleProtagoniste2)vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(succes1 and succes1)or(not succes1 and not succes2)then if(seuilEffectif1 > seuilEffectif2 and true)then libelleAction= libelleAction..string.format( "[u]%s remporte le Test de peu[/u], d√©partag√© par le Seuil du Test.", libelleProtagoniste1 )vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(seuilEffectif1 < seuilEffectif2 and true)then libelleAction= libelleAction..string.format("[u]%s remporte le Test[/u], d√©partag√© par le Seuil du Test.", libelleProtagoniste2)vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(seuilEffectif1 == seuilEffectif2 and true)then if seuilBase1>seuilBase2 then libelleAction= libelleAction..string.format( "[u]%s remporte le Test[/u], d√©partag√© par le Score de comp√©tence.", libelleProtagoniste1 )vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(seuilBase1 < seuilBase2 and true)then libelleAction= libelleAction..string.format( "[u]%s remporte le Test[/u], d√©partag√© par le Score de comp√©tence.", libelleProtagoniste2 )vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(seuilBase1 == seuilBase2 and true)then if(d100_1 < d100_2 and true)then libelleAction= libelleAction..string.format( "[u]%s remporte le Test[/u], d√©partag√© par le Lancer de d√©.", libelleProtagoniste1 )vainqueur=libelleProtagoniste1 perdant=libelleProtagoniste2 elseif(d100_1 > d100_2 and true)then libelleAction= libelleAction..string.format( "[u]%s remporte le Test[/u], d√©partag√© par le Lancer de d√©.", libelleProtagoniste2 )vainqueur=libelleProtagoniste2 perdant=libelleProtagoniste1 elseif(d100_1 == d100_2 and true)then libelleAction= libelleAction..string.format("[u]Aucun protagoniste ne remporte le Test, c'est une √©galit√© parfaite[/u].")end end end end end local libelleActionBis=""if succes1 and succes2 then libelleActionBis= libelleActionBis..string.format( "Les deux protagonistes ont r√©ussi, mais %s a tout de m√™me pris le dessus sur %s.", vainqueur, perdant )elseif(succes1 and not succes2)or(succes2 and not succes1)then libelleActionBis= libelleActionBis..string.format("Le r√©sultat est clair, sans ambig√ºit√© : %s a r√©ussi et %s a √©chou√©.", vainqueur, perdant)elseif not succes1 and not succes2 then libelleActionBis= libelleActionBis.."Toutefois, les deux protagonistes ont √©chou√©, quel duel de bras cass√©s !"end local myfooter=""myfooter= myfooter..'[hr style="border: color; margin: 5px; "]'myfooter= myfooter..'[div style="display: flex;margin-top: 10px"]'myfooter= myfooter..'[div style="display: flex; flex-grow: 1; justify-content: center"]'myfooter= myfooter..'[div style="color: white"]'myfooter= myfooter..'[div style="color: white; font-size: 1.2em; font-weight: bold; padding-bottom:5px; line-height: 1.4em"]' .. libelleAction .. "[/div]"myfooter= myfooter..'[div style="color: white; font-weight: bold; padding-top:5px"]' .. libelleActionBis .. "[/div]"myfooter= myfooter.."[/div]"myfooter= myfooter.."[/div]"myfooter= myfooter.."[/div]"return rpg.smf.save(myheader,myrolls,myresults,myfooter,"wfrp4")end function rpg.accel.test(s)local rolls,myheader=rpg.smf.striptitle(s)local typetest=string.match(s,"([%w%p]*)[%s]*")typetest= tostring(typetest)or""if((typetest == "simple" or typetest == "spectaculaire")and true)then local seuilBase,difficulte=string.match(s,"%w*[%s]*(%d*)[%s]*(%w*)[%s]*")seuilBase= tonumber(seuilBase)or nil difficulte=GetCodeDifficulte(tostring(difficulte)or"")local modificateurDifficulte=GetModificateurDifficulte(difficulte)local seuilEffectif=GetSeuilEffectif(seuilBase,modificateurDifficulte)local jets=rpg.roll.dice(2,0,9)local d1=jets[1]local d2=jets[2]local succes=IsSuccess(GetD100(d1,d2),seuilEffectif)local echec=IsFailure(GetD100(d1,d2),seuilEffectif)local critique=IsCritical(typetest,d1,d2)return EvaluateTest(typetest,seuilBase,seuilEffectif,difficulte,d1,d2)elseif(typetest == "oppose"and true)then local protagoniste1,seuilBase1,difficulte1,protagoniste2,seuilBase2,difficulte2=string.match(s,"%w*[%s]+([%w%p]*)[%s]+(%d+)[%s]+([%w]*)[%s]*/[%s]*([%w%p]+)[%s]*(%d+)[%s]*([%w]*)")seuilBase1= tonumber(seuilBase1)or nil seuilBase2= tonumber(seuilBase2)or nil if(difficulte1 == ""and true)then difficulte1="I"end if(difficulte2 == ""and true)then difficulte2="I"end difficulte1=GetCodeDifficulte(difficulte1)difficulte2=GetCodeDifficulte(difficulte2)local modificateurDifficulte1=GetModificateurDifficulte(difficulte1)local modificateurDifficulte2=GetModificateurDifficulte(difficulte2)local seuilEffectif1=GetSeuilEffectif(seuilBase1,modificateurDifficulte1)local seuilEffectif2=GetSeuilEffectif(seuilBase2,modificateurDifficulte2)local jets1=rpg.roll.dice(2,0,9)local jets2=rpg.roll.dice(2,0,9)local d1_1=jets1[1]local d1_2=jets2[1]local d2_1=jets1[2]local d2_2=jets2[2]local succes1=IsSuccess(GetD100(d1_1,d2_1),seuilEffectif1)local succes2=IsSuccess(GetD100(d1_2,d2_2),seuilEffectif2)local echec1=IsFailure(GetD100(d1_1,d2_1),seuilEffectif1)local echec2=IsFailure(GetD100(d1_2,d2_2),seuilEffectif2)local critique1=IsCritical(typetest,d1_1,d2_1)local critique2=IsCritical(typetest,d1_2,d2_2)return EvaluateTestOppose(protagoniste1,seuilBase1,seuilEffectif1,difficulte1,d1_1,d2_1,protagoniste2,seuilBase2,seuilEffectif2,difficulte2,d1_2,d2_2)elseif(typetest == "corps-a-corps"and true)then local protagoniste1,seuilBase1,difficulte1,avantage1,bonusForce1=string.match(s,"%w*[%s]+([%w%p]*)[%s]+(%d+)[%s]+([%w]*)[%s]*(%d*)A[%s]*(%d*)BF[%s]*.*/.*")local atoutEnroulement=string.match(s,".*Enroulement.*/")atoutEnroulement= atoutEnroulement~=nil local atoutPoudre=string.match(s,".*(Poudre).*/")atoutPoudre= atoutPoudre~=nil local atoutAssommante=string.match(s,".*(Assommante).*/")atoutAssommante= atoutAssommante~=nil print("atoutAssommante",atoutAssommante)local atoutDefensive=string.match(s,".*(D√©fensive).*/")atoutDefensive= atoutDefensive~=nil print("atoutDefensive",atoutDefensive)local atoutDevastatrice=string.match(s,".*(D√©vastatrice).*/")atoutDevastatrice= atoutDevastatrice~=nil print("atoutDevastatrice",atoutDevastatrice)local atoutEmpaleuse=string.match(s,".*(Empaleuse).*/")atoutEmpaleuse= atoutEmpaleuse~=nil print("atoutEmpaleuse",atoutEmpaleuse)local atoutExplosion=string.match(s,".*Explosion.*/")atoutExplosion= atoutExplosion~=nil print("atoutExplosion",atoutExplosion)local indiceAtoutExplosion=string.match(s,".*Explosion(%d*).*/")print("indiceAtoutExplosion",indiceAtoutExplosion)local atoutImmobilisante=string.match(s,".*(Immobilisante).*/")atoutImmobilisante= atoutImmobilisante~=nil print("atoutImmobilisante",atoutImmobilisante)local atoutIncassable=string.match(s,".*(Incassable).*/")atoutIncassable= atoutIncassable~=nil print("atoutIncassable",atoutIncassable)local atoutPercutante=string.match(s,".*(Percutante).*/")atoutPercutante= atoutPercutante~=nil print("atoutPercutante",atoutPercutante)local atoutPerforante=string.match(s,".*(Perforante).*/")atoutPerforante= atoutPerforante~=nil print("atoutPerforante",atoutPerforante)local atoutPerturbante=string.match(s,".*(Perturbante).*/")atoutPerturbante= atoutPerturbante~=nil print("atoutPerturbante",atoutPerturbante)local atoutPiegeLame=string.match(s,".*(Pi√®ge-lame).*/")atoutPiegeLame= atoutPiegeLame~=nil print("atoutPiegeLame",atoutPiegeLame)local atoutPistolet=string.match(s,".*(Pistolet).*/")atoutPistolet= atoutPistolet~=nil print("atoutPistolet",atoutPistolet)local atoutPointue=string.match(s,".*(Pointue).*/")atoutPointue= atoutPointue~=nil print("atoutPointue",atoutPointue)local atoutPrecise=string.match(s,".*(Pr√©cise).*/")atoutPrecise= atoutPrecise~=nil print("atoutPrecise",atoutPrecise)local atoutProtectrice=string.match(s,".*Protectrice.*/")atoutProtectrice= atoutProtectrice~=nil print("atoutProtectrice",atoutProtectrice)local indiceAtoutProtectrice=string.match(s,".*Protectrice(%d*).*/")print("atoutProtectrice(%d)",indiceAtoutProtectrice)local atoutRapide=string.match(s,".*(Rapide).*/")atoutRapide= atoutRapide~=nil print("atoutRapide",atoutRapide)local atoutTaille=string.match(s,".*(Taille).*/")atoutTaille= atoutTaille~=nil print("atoutTaille",atoutTaille)local protagoniste2,seuilBase2,difficulte2,avantage2=string.match(s,".*/[%s]*([%w%p]+)[%s]*(%d+)[%s]*([%w]*)[%s]*(%d*)A[%s]*")seuilBase1= tonumber(seuilBase1)or nil seuilBase2= tonumber(seuilBase2)or nil avantage1= tonumber(avantage1)or 0 avantage2= tonumber(avantage2)or 0 bonusForce1= tonumber(bonusForce1)or 0 print("TestCorpsACorps:avantage1",avantage1)print("TestCorpsACorps:avantage2",avantage2)print("TestCorpsACorps:bonusForce1",bonusForce1)if(difficulte1 == ""and true)then difficulte1="I"end if(difficulte2 == ""and true)then difficulte2="I"end difficulte1=GetCodeDifficulte(difficulte1)difficulte2=GetCodeDifficulte(difficulte2)local modificateurDifficulte1=GetModificateurDifficulte(difficulte1)local modificateurDifficulte2=GetModificateurDifficulte(difficulte2)local seuilEffectif1=GetSeuilEffectif(seuilBase1,modificateurDifficulte1)local seuilEffectif2=GetSeuilEffectif(seuilBase2,modificateurDifficulte2)seuilEffectif1= seuilEffectif1+(avantage1 * 10)seuilEffectif2= seuilEffectif2+(avantage2 * 10)local jets1=rpg.roll.dice(2,0,9)local jets2=rpg.roll.dice(2,0,9)local d1_1=jets1[1]local d1_2=jets2[1]local d2_1=jets1[2]local d2_2=jets2[2]local succes1=IsSuccess(GetD100(d1_1,d2_1),seuilEffectif1)local succes2=IsSuccess(GetD100(d1_2,d2_2),seuilEffectif2)local echec1=IsFailure(GetD100(d1_1,d2_1),seuilEffectif1)local echec2=IsFailure(GetD100(d1_2,d2_2),seuilEffectif2)local critique1=IsCritical(typetest,d1_1,d2_1)local critique2=IsCritical(typetest,d1_2,d2_2)return EvaluateTestCorpsACorps(protagoniste1,seuilBase1,seuilEffectif1,difficulte1,avantage1,d1_1,d2_1,bonusForce1,protagoniste2,seuilBase2,seuilEffectif2,difficulte2,avantage2,d1_2,d2_2)elseif(typetest == "distance"and true)then print("Test d'Attaque √† distance:",typetest)else print("Test de type inconnu:",typetest)end end